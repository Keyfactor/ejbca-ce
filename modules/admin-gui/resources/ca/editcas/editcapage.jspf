<%@page import="org.cesecore.keys.token.CryptoTokenFactory"%>
<%@page import="org.ejbca.core.model.ca.caadmin.extendedcaservices.BaseSigningCAServiceInfo"%>
<%@page import="org.apache.commons.lang.StringUtils"%>
<%@page import="org.ejbca.util.HTMLTools" %>

<%               
  TreeMap<String,Integer> rootcaprofiles = ejbcawebbean.getAuthorizedRootCACertificateProfileNames();
  TreeMap<String,Integer> subcaprofiles = ejbcawebbean.getAuthorizedSubCACertificateProfileNames();      
  Map<String,Integer> casigners = ejbcawebbean.getActiveCANames();
  Map<Integer,String> publisheridtonamemap = ejbcawebbean.getPublisherIdToNameMapByValue();
  Map<Integer, String> keyValidatorMap = ejbcawebbean.getEjb().getKeyValidatorSession().getKeyValidatorIdToNameMap();
  Map<Integer, String> approvalProfileMap = ejbcawebbean.getApprovalProfileIdToNameMap();

  Collection<AvailableCryptoToken> availablecatokens = CryptoTokenFactory.instance().getAvailableCryptoTokens();
  String[] availablecatokentypes = new String[availablecatokens.size()];
  String[] availablecatokentypetexts = new String[availablecatokens.size()];  

  int numberofavailabletokens = 0;
  for (final AvailableCryptoToken nextavailable : availablecatokens) {
      if (nextavailable.isUsed()) {
          availablecatokentypes[numberofavailabletokens] = nextavailable.getClassPath();
          if (nextavailable.isTranslateable()) {
              availablecatokentypetexts[numberofavailabletokens] =  ejbcawebbean.getText(nextavailable.getName());
          } else {
              availablecatokentypetexts[numberofavailabletokens] =  nextavailable.getName();
          }
          numberofavailabletokens++;
      }
  }
 
  row = 0;
  CAInfo cainfo = null;
  
  String catokentext = null;
  CAToken catoken = null;
  int currentCryptoTokenId = 0;
  
  boolean revokable = true;
  boolean signbyexternal = false;
  boolean isexternal = false;
  boolean isRevoked = false;
  boolean waitingresponse = false;  
  boolean isUninitialized = false;
  boolean hasEditRights = cabean.hasEditRight();
  boolean hasCreateRights = cabean.hasCreateRight();
  boolean acceptRevocationsNonExistingEntries = false;
  
  CmsCAServiceInfo cmscainfo = null; 
  java.security.cert.X509Certificate cmscert = null; 
  if (editca) {
    // Defaults in the edit and initialize pages
    cainfo = cabean.getCAInfo(caid).getCAInfo();
    catoken = cainfo.getCAToken();
    keyValidatorMap = ejbcawebbean.getEjb().getKeyValidatorSession().getKeyValidatorIdToNameMap(cainfo.getCAType());
    if (signatureAlgorithmParam == null || signatureAlgorithmParam.isEmpty()) {
        signatureAlgorithmParam = catoken.getSignatureAlgorithm();
    }
    signbyexternal = cainfo.getSignedBy() == CAInfo.SIGNEDBYEXTERNALCA;
    isexternal = cainfo.getStatus() == CAConstants.CA_EXTERNAL;
    isRevoked = cainfo.getStatus() == CAConstants.CA_REVOKED || cadatahandler.isCARevoked(cainfo);
    revokable = cainfo.getStatus() != CAConstants.CA_REVOKED  && cainfo.getStatus() != CAConstants.CA_WAITING_CERTIFICATE_RESPONSE && !cadatahandler.isCARevoked(cainfo);
    waitingresponse = cainfo.getStatus() == CAConstants.CA_WAITING_CERTIFICATE_RESPONSE;
    isUninitialized = cainfo.getStatus() == CAConstants.CA_UNINITIALIZED;
    if (!isexternal) {
	    for (final ExtendedCAServiceInfo extendedCAServiceInfo : cainfo.getExtendedCAServiceInfos()) {
	        if (extendedCAServiceInfo instanceof CmsCAServiceInfo) {
	            cmscainfo = (CmsCAServiceInfo) extendedCAServiceInfo;
	            if (cmscainfo.getCertificatePath() != null) {
		            cmscert = (java.security.cert.X509Certificate) cmscainfo.getCertificatePath().get(0);
	            }
	        }
	        
	        if (extendedServicesKeySpecParam == null && extendedCAServiceInfo instanceof BaseSigningCAServiceInfo) {
                extendedServicesKeySpecParam = ((BaseSigningCAServiceInfo)extendedCAServiceInfo).getKeySpec();
            }
	    }  
	}
  } else {
    // Defaults in the create CA page
    if (signatureAlgorithmParam == null || signatureAlgorithmParam.length()==0) {
        signatureAlgorithmParam = AlgorithmConstants.SIGALG_SHA256_WITH_RSA;
    }
  }
  
  keyValidatorMap = ejbcawebbean.getEjb().getKeyValidatorSession().getKeyValidatorIdToNameMap(catype);
  
  String hidden_ca_key;
  String hidden_ca_value;
  if (isUninitialized) {
    hidden_ca_key = HIDDEN_CAID;
    hidden_ca_value = String.valueOf(cainfo.getCAId());
  } else {
    hidden_ca_key = HIDDEN_CANAME;
    hidden_ca_value = caname;
  }
%>
<script type="text/javascript">
<!--  
<% if (!editca || isUninitialized) { %>
  var rootcaprofiles = new Array(<%= rootcaprofiles.keySet().size()%>);
  var subcaprofiles = new Array(<%= subcaprofiles.keySet().size()%>);
  var NAME       = 0;
  var ID         = 1;
<%
      Iterator iter = rootcaprofiles.keySet().iterator();
      int i = 0;
      while(iter.hasNext()){
        String next = (String) iter.next();  %> 
    rootcaprofiles[<%=i%>] = new Array(2);
    rootcaprofiles[<%=i%>][NAME] = "<%= HTMLTools.javascriptEscape(next) %>";
    rootcaprofiles[<%=i%>][ID] = <%= rootcaprofiles.get(next) %>;
   <%   i++; 
      }
 
      iter = subcaprofiles.keySet().iterator();
      i = 0;
      while(iter.hasNext()){
        String next = (String) iter.next();  %> 
    subcaprofiles[<%=i%>] = new Array(2);
    subcaprofiles[<%=i%>][NAME] = "<%= HTMLTools.javascriptEscape(next) %>";
    subcaprofiles[<%=i%>][ID] = <%= subcaprofiles.get(next) %>;
   <%   i++;
      }
%>
      
function fillCertProfileField(){
   var certprofselect   =  document.ca.<%=SELECT_CERTIFICATEPROFILE%>;

   var num = certprofselect.length;
   var selectedProfile = certprofselect.selectedIndex != -1 && num > 0 ? 
           certprofselect.options[certprofselect.selectedIndex].value : null; 
   for( i=num-1; i >= 0; i-- ){
       certprofselect.options[i]=null;
    }   
 
   var profiles = subcaprofiles;
   if(document.ca.<%= SELECT_SIGNEDBY %>.options[document.ca.<%= SELECT_SIGNEDBY %>.options.selectedIndex].value == <%= CAInfo.SELFSIGNED %>)
      profiles = rootcaprofiles;

   var indexToSelect = -1;
   for( i=0; i < profiles.length; i ++){
     var isSelected = profiles[i][ID] == selectedProfile;
     certprofselect.options[i]=new Option(profiles[i][NAME],
                                     profiles[i][ID],
                                     isSelected, isSelected);    
   }
}

function isExternalX509(){
   var subjectaltname  =  document.ca.<%=TEXTFIELD_SUBJECTALTNAME%>;
   var policyidfield   =  document.ca.<%=TEXTFIELD_POLICYID%>;
   var activatecms     =  document.ca.<%=CHECKBOX_ACTIVATECMSSERVICE%>;
   var ncpermitted     =  document.ca.<%=TEXTFIELD_NAMECONSTRAINTSPERMITTED%>;
   var ncexcluded      =  document.ca.<%=TEXTFIELD_NAMECONSTRAINTSEXCLUDED%>;
   
   if (subjectaltname != null) {	
	   subjectaltname.disabled = false; 
	   policyidfield.disabled = false;    
	   activatecms.disabled = false;
	   activatecms.checked = false;   
       ncpermitted.disabled = false;
       ncexcluded.disabled = false;
	
	   if(document.ca.<%= SELECT_SIGNEDBY %>.options[document.ca.<%= SELECT_SIGNEDBY %>.options.selectedIndex].value == <%= CAInfo.SIGNEDBYEXTERNALCA %>){
	      subjectaltname.disabled = true; 
	      policyidfield.disabled = true;   
	      activatecms.disabled = true;
	      activatecms.checked = false;
		  ncpermitted.disabled = true;
          ncexcluded.disabled = true;
	   } 
   }
}

function isExternalGeneric(){
   var makebutton         =  document.ca.<%= BUTTON_MAKEREQUEST %>;
   var createorinitbutton =  document.ca.<%= isUninitialized ? BUTTON_INITIALIZE : BUTTON_CREATE %>; 
   var certproffield      =  document.ca.<%=SELECT_CERTIFICATEPROFILE %>;
   var validityfield      =  document.ca.<%=TEXTFIELD_VALIDITY%>;

   makebutton.disabled = true;
   createorinitbutton.disabled = false;
   certproffield.disabled = false;
   validityfield.disabled = false;

   if(document.ca.<%= SELECT_SIGNEDBY %>.options[document.ca.<%= SELECT_SIGNEDBY %>.options.selectedIndex].value == <%= CAInfo.SIGNEDBYEXTERNALCA %>){
      makebutton.disabled = false;
      <% if (!isUninitialized) { %>createorinitbutton.disabled = true;<% } %>
      certproffield.disabled = true;
      validityfield.disabled = true;
   } 
}
<% } %>
function hideShowThrowAwayCAItems() {
    <% if (catype == CAInfo.CATYPE_X509) { %>
        var shown = !document.ca.<%=CHECKBOX_USECERTIFICATESTORAGE%>.checked;
        var items = document.getElementsByClassName("onlyShowForThrowAwayCA");
        for (var i = 0; i < items.length; i++) {
            items[i].style.display = shown ? '' : 'none';
        }
    <% } %>
}

function selectDefaultCertificateProfile(){
    <% if (catype == CAInfo.CATYPE_X509) { %>
	if (document.ca.<%=CHECKBOX_USECERTIFICATESTORAGE%>.checked || !document.ca.<%=CHECKBOX_ACCEPTREVOCATIONSNONEXISTINGENTRY%>.checked) {
		document.ca.<%=SELECT_DEFAULTCERTPROFILE%>.disabled = true;
	} else {
		document.ca.<%=SELECT_DEFAULTCERTPROFILE%>.disabled = false;
	}
	<% } %>
}

function updateCertificateDataTableToUseFieldStatus() {
    <% if (catype == CAInfo.CATYPE_X509) { %>
	if (document.ca.<%=CHECKBOX_USECERTIFICATESTORAGE%>.checked || !document.ca.<%=CHECKBOX_ACCEPTREVOCATIONSNONEXISTINGENTRY%>.checked) {
		document.ca.<%=CHECKBOX_USEAPPENDONLYTABLE%>.disabled = true;
        acceptRevocationsNonExistingEntries = false;
	} else {
		document.ca.<%=CHECKBOX_USEAPPENDONLYTABLE%>.disabled = false;
        acceptRevocationsNonExistingEntries = true;
	}
	<% } %>
}

function checkAcceptNonExistingEntries(){
	<% if (catype == CAInfo.CATYPE_X509) { %>
	if (document.ca.<%=CHECKBOX_USECERTIFICATESTORAGE%>.checked) {
		document.ca.<%=CHECKBOX_ACCEPTREVOCATIONSNONEXISTINGENTRY%>.disabled = true;
	} else {
		document.ca.<%=CHECKBOX_ACCEPTREVOCATIONSNONEXISTINGENTRY%>.disabled = false;
	}
	<% } %>
}
function gendefaultcrldistpoint(){
 <% if(!editca){ %>
    document.ca.<%=TEXTFIELD_DEFAULTCRLDISTPOINT%>.value = "<%=globalconfiguration.getStandardCRLDistributionPointURINoDN() %>" + encodeURI(document.ca.<%=TEXTFIELD_SUBJECTDN%>.value);	
 <% }else{ %>
    document.ca.<%=TEXTFIELD_DEFAULTCRLDISTPOINT%>.value = "<%=globalconfiguration.getStandardCRLDistributionPointURINoDN() %>" + encodeURI("<%=cainfo.getSubjectDN()%>");
 <% } %>
}

function gendefaultcrlissuer() {
 <% if(!editca){ %>
    document.ca.<%=TEXTFIELD_DEFAULTCRLISSUER%>.value = document.ca.<%=TEXTFIELD_SUBJECTDN%>.value;
 <% }else{ %>
    document.ca.<%=TEXTFIELD_DEFAULTCRLISSUER%>.value = "<%= cainfo.getSubjectDN()%>";
 <% } %>
}

function gencadefinedfresherstcrl() {
 <% if(!editca){ %>
    document.ca.<%=TEXTFIELD_CADEFINEDFRESHESTCRL%>.value = "<%=globalconfiguration.getStandardDeltaCRLDistributionPointURINoDN() %>" + encodeURI(document.ca.<%=TEXTFIELD_SUBJECTDN%>.value);
 <% }else{ %>
    document.ca.<%=TEXTFIELD_CADEFINEDFRESHESTCRL%>.value = "<%=globalconfiguration.getStandardDeltaCRLDistributionPointURINoDN() %>" + encodeURI("<%=cainfo.getSubjectDN()%>");
 <% } %>
}

function gendefaultocsplocator(){
    document.ca.<%=TEXTFIELD_DEFAULTOCSPLOCATOR%>.value = "<%=globalconfiguration.getStandardOCSPServiceLocatorURI() %>";
}
<% if(revokable){ %>
function confirmrevocation(){
  var returnval = false;
  if(document.ca.<%= SELECT_REVOKEREASONS %>.options.selectedIndex == -1){
     alert("<%= ejbcawebbean.getText("AREVOKEATIONREASON", true) %>"); 
     returnval = false;
  }else{
    returnval = confirm("<%= ejbcawebbean.getText("AREYOUSUREREVOKECA",true) %>");
  } 
  return returnval;
}

<%  }  

  if(editca && !waitingresponse){%>
function viewcacert(){
    win_popup = window.open('<%=VIEWCERT_LINK%>?caid=<%=caid%>', 'view_cert','height=750,width=750,scrollbars=yes,toolbar=no,resizable=1');
    win_popup.focus();
}
  
  <% } if(editca && !isexternal){ %>
function confirmrenewal(){
  return confirm("<%= ejbcawebbean.getText("AREYOUSURERENEWCA",true) %>") && checkallfields();     
}

<%  if(cmscert != null){ %>
  function viewcmscert(){        
      var link = "<%= VIEWCERT_LINK %>?<%= CERTSERNO_PARAMETER %>=<%= java.net.URLEncoder.encode(cmscert.getSerialNumber().toString(16) + "," + CertTools.getIssuerDN(cmscert),"UTF-8")%>";
      link = encodeURI(link);
      win_popup = window.open(link, 'view_cert','height=750,width=750,scrollbars=yes,toolbar=no,resizable=1');
      win_popup.focus();
  }
  <% } 
}  %>  

function checkusefield(usefield, criticalfield){
  var usebox = eval("document.ca." + usefield);
  var cribox = eval("document.ca." + criticalfield);
  if(usebox.checked){
    cribox.disabled = false;
  }
  else{
    cribox.checked=false;
    cribox.disabled = true;
  }
}

function checkallfields(){
    var illegalfields = 0;
	var jumpTo = '';
    <% 
    if(!editca || (editca && cainfo.getSignedBy() != CAInfo.SIGNEDBYEXTERNALCA)){ %>
	    if((document.ca.<%= TEXTFIELD_VALIDITY %>.value == "") && document.ca.<%= SELECT_SIGNEDBY %>.options[document.ca.<%= SELECT_SIGNEDBY %>.options.selectedIndex].value != <%= CAInfo.SIGNEDBYEXTERNALCA %>){
	      alert("<%= ejbcawebbean.getText("YOUAREREQUIRED", true) + " " + ejbcawebbean.getText("CERT_CORRECT_VALIDITY", true)%>");
	      illegalfields++;
	      if(jumpTo == '') { jumpTo = '<%=TEXTFIELD_VALIDITY%>'; }
	    }   
    <% } %>
    
    <% if(!editca){ %>
    if(!checkfieldforcompletednchars("document.ca.<%=TEXTFIELD_SUBJECTDN%>","<%= ejbcawebbean.getText("ONLYCHARACTERS") + " " + ejbcawebbean.getText("CERT_SUBJECTDN") %>"))
      illegalfields++;
    if((document.ca.<%= TEXTFIELD_SUBJECTDN %>.value == "")){
      alert("<%= ejbcawebbean.getText("YOUAREREQUIRED", true) + " " + ejbcawebbean.getText("CERT_SUBJECTDN", true)%>");
      illegalfields++;
      if(jumpTo == '') { jumpTo = '<%=TEXTFIELD_SUBJECTDN%>'; }
    } else if((document.ca.<%= TEXTFIELD_SUBJECTDN %>.value.indexOf("=")==-1)){
		alert("<%= ejbcawebbean.getText("SUBJECTDNINVALID")%>");
		illegalfields++;
		if(jumpTo == '') { jumpTo = '<%=TEXTFIELD_SUBJECTDN%>'; }
    } else {
    <% if(catype == CAInfo.CATYPE_CVC) { %>
        var value = document.ca.<%= TEXTFIELD_SUBJECTDN %>.value;
        var hasCN = value.match(/(^|,(\s*))CN=/i);
        var hasC = value.match(/(^|,(\s*))C=/i);
        
        if (value != "" && (!hasCN || !hasC)) {
            alert("<%= ejbcawebbean.getText("SUBJECTDNBADFORCVC")%>");
            illegalfields++;
            if(jumpTo == '') { jumpTo = '<%=TEXTFIELD_SUBJECTDN%>'; }
        }
    <% } %>
    }
   <% } %> 

  <% if(catype == CAInfo.CATYPE_X509){ 
         if(!editca){%>        
    if(!checkfieldforcompletednchars("document.ca.<%=TEXTFIELD_SUBJECTALTNAME%>","<%= ejbcawebbean.getText("ONLYCHARACTERS") + " " + ejbcawebbean.getText("SUBJECTALTNAME")%>"))
      illegalfields++;
   if(!checkfieldforipaddess("document.ca.<%=TEXTFIELD_POLICYID%>","<%= ejbcawebbean.getText("ONLYNUMBERALSANDDOTS") + ejbcawebbean.getText("POLICYID")%>"))
      illegalfields++;
      <% } %>
    if(!checkFieldForCrlSimpleTime("document.ca.<%=TEXTFIELD_CRLPERIOD%>","<%= ejbcawebbean.getText("INVALIDCRLEXPIREPERIOD") %>"))
      illegalfields++;
    if((document.ca.<%= TEXTFIELD_CRLPERIOD %>.value == "")){
      alert("<%= ejbcawebbean.getText("YOUAREREQUIRED") + " " + ejbcawebbean.getText("CRL_CA_CRLPERIOD")%>");
      illegalfields++;
      if(jumpTo == '') { jumpTo = '<%=TEXTFIELD_CRLPERIOD%>'; }
    }
    if(!checkFieldForCrlSimpleTime("document.ca.<%=TEXTFIELD_CRLISSUEINTERVAL%>","<%= ejbcawebbean.getText("INVALIDCRLISSUEINTERVAL") %>"))
        illegalfields++;
    if(!checkFieldForCrlSimpleTime("document.ca.<%=TEXTFIELD_CRLOVERLAPTIME%>","<%= ejbcawebbean.getText("INVALIDCRLOVERLAPTIME") %>"))
        illegalfields++;
    if(!checkFieldForCrlSimpleTime("document.ca.<%=TEXTFIELD_DELTACRLPERIOD%>","<%= ejbcawebbean.getText("INVALIDDELTACRLPERIOD") %>"))
      illegalfields++;
    if((document.ca.<%= TEXTFIELD_DELTACRLPERIOD %>.value == "")){
      alert("<%= ejbcawebbean.getText("YOUAREREQUIRED") + " " + ejbcawebbean.getText("CRL_CA_DELTACRLPERIOD")%>");
      illegalfields++;
      if(jumpTo == '') { jumpTo = '<%=TEXTFIELD_DELTACRLPERIOD%>'; }
    }
    <% if(editca && globalconfiguration.getEnableIcaoCANameChange() ){%>
	    var caNameChange     =  document.ca.<%=CHECKBOX_CANAMECHANGE%>;
	    if(caNameChange.checked && !checkfieldforcompletednchars("document.ca.<%=TEXTFIELD_NEWSUBJECTDN%>","<%= ejbcawebbean.getText("ONLYCHARACTERS") + " " + ejbcawebbean.getText("CERT_SUBJECTDN") %>"))
	        illegalfields++;
	    if(caNameChange.checked && document.ca.<%= TEXTFIELD_NEWSUBJECTDN %>.value.match(/(cn){1}\s*=+/i)==null){//Just check if Common Name exists in the DN
			alert("<%= ejbcawebbean.getText("NEWSUBJECTDNINVALID")%>");
			illegalfields++;
			if(jumpTo == '') { jumpTo = '<%=ID_NEWSUBJECTDN%>'; }
	    }
	    if(caNameChange.checked && document.ca.<%= TEXTFIELD_NEWSUBJECTDN %>.value == "<%= cainfo.getSubjectDN() %>"){
			alert("<%= ejbcawebbean.getText("NEWSUBJECTDNSAMEASCURRENT")%>");
			illegalfields++;
			if(jumpTo == '') { jumpTo = '<%=ID_NEWSUBJECTDN%>'; }
	    }
	<% } %>
    <%
    } %> 
     if(jumpTo != '') {
    	 //Go there.
    	 document.getElementById(jumpTo).scrollIntoView();
    	 document.getElementById(jumpTo).focus();
     }
     return illegalfields == 0;  
   }
   
function toggleCANameChange(){
	var value =  document.getElementById('<%=ID_CHECKBOX_CANAMECHANGE%>').checked ? false : true;
	document.getElementById('<%=ID_NEWSUBJECTDN%>').disabled = value;
}

function pageLoad() {
	<% if(!editca || isUninitialized) out.write("fillCertProfileField();"); %>
	hideShowThrowAwayCAItems();
}
-->

</script>
<body onload="pageLoad()"> 
<jsp:include page="../../adminmenu.jsp" />


<div class="main-wrapper">
<div class="container">
<div align="center">
  <% if (editca && hasEditRights) { //Editing %> 
  <h2><%= ejbcawebbean.getText("EDITCA") %></h2>
  <h3><%= ejbcawebbean.getText("CANAME")+ " : "%><c:out value="<%= cainfo.getName() %>"/></h3>
  <% } else if(editca){ //Just viewing%>  
   <h2><%= ejbcawebbean.getText("VIEWCA") %></h2>
   <h3><%= ejbcawebbean.getText("CANAME")+ " : "%><c:out value="<%= cainfo.getName() %>"/></h3>
  <% } else { %>
   <h2><%= ejbcawebbean.getText("CREATECA") %></h2>
   <h3><%= ejbcawebbean.getText("CANAME")+ " : "%><c:out value="<%= caname %>"/></h3>
  <% } %>
</div>
  <table class="edit" width="100%" border="0" cellspacing="3" cellpadding="3">
    <tr id="Row<%=row++%2%>"> 
      <td width="50%" valign="top" align="left"> 
        &nbsp;
      </td>
      <td width="50%" valign="top" align="right"> 
        <a href="<%=THIS_FILENAME %>"><%= ejbcawebbean.getText("BACKTOCAS") %></a>
      </td>
    </tr>

    <%-- ---------- Main -------------------- --%>

      <% if (editca) { %>
      <tr id="Row<%=row++%2%>"> 
          <td width="50%" align="right"><%= ejbcawebbean.getText("CAID") %></td>
          <td width="50%" valign="top"><%=cainfo.getCAId() %></td>
      </tr>
      <% } %>

        <tr id="Row<%=row++%2%>"> 
            <td width="50%"  align="right"><%= ejbcawebbean.getText("CATYPE") %> <%= ejbcawebbean.getHelpReference("/Certificate_Authority_Overview.html#CA_Types") %></td>
            <td width="50%" valign="top">
            <% if (!editca) { %> 
            <form name="changecatype" action="<%= THIS_FILENAME %>" method="post">
                <input type="hidden" name="<csrf:tokenname/>" value="<csrf:tokenvalue/>"/>
                <input type="hidden" name='<%= ACTION %>' value='<%=ACTION_CHOOSE_CATYPE %>'>
                <input type="hidden" name='<%= hidden_ca_key %>' value='<c:out value="<%= hidden_ca_value %>"/>'/>
                <select name="<%=SELECT_CATYPE %>" size="1" onchange="document.changecatype.submit()">                
                    <option value="<%=CAInfo.CATYPE_X509%>" <%if(catype == CAInfo.CATYPE_X509) out.write("selected");%>>X509</option>
                    <option value="<%=CAInfo.CATYPE_CVC%>" <%if(catype == CAInfo.CATYPE_CVC) out.write("selected");%>>CVC</option>  
	            </select> 
	            <input id="changecatypeUpdateButton" type="image" src="reload.png" alt="Reload"/>
	            <script>document.getElementById('changecatypeUpdateButton').style.display = 'none';</script>
            </form>
	        <% } else { 
	    	    if (catype == CAInfo.CATYPE_X509) { out.write("X509"); }
	            else if (catype == CAInfo.CATYPE_CVC) { out.write("CVC"); }
	            else { out.write("UNKNOWN"); }
	           } %>
            </td>
        </tr>
        <% if ( (catype == CAInfo.CATYPE_CVC) && (!cabean.isCVCAvailable() || cabean.isUniqueIssuerDNSerialNoIndexPresent()) ) { %>
        <tr id="Row<%=row++%2%>">
            <td width="50%" align="right"></td>
            <% if ( !cabean.isCVCAvailable() ) { %>
                <td class="alert"><%= ejbcawebbean.getText("CVCCANOTAVAILABLE") %></td>
            <% } else { %>
                <td class="alert"><%= ejbcawebbean.getText("CVCCANOTAVAILABLEUNIQUEINDEX") %></td>
            <% } %>
        </tr>
        <% } else { 
        // begin "IF CVC AVAILABLE", search for "IF CVC AVAILABLE" to find the end } in the end of this file 
        %>
        
        <% if (editca && !isUninitialized && !isexternal) { %>
        <tr id="Row<%=row++%2%>">
            <td width="50%" align="right">
            <strong><%= ejbcawebbean.getText("SIGNINGALGORITHM") %></strong></td>
	        <td><%= catoken.getSignatureAlgorithm() != null ? catoken.getSignatureAlgorithm() : ejbcawebbean.getText("NOTUSED") %></td>
        </tr>
        <tr id="Row<%=row%2%>">
            <td width="50%" align="right">
            <strong><%= ejbcawebbean.getText("CRYPTOTOKEN") %></strong> <%= ejbcawebbean.getHelpReference("/Managing_Crypto_Tokens.html") %></td>
            <td>
            <% if (cabean.isCryptoTokenPresent(catoken.getCryptoTokenId())) { %>
            <a href="<%= ejbcawebbean.getBaseUrl() + globalconfiguration.getAdminWebPath() + "cryptotoken/cryptotoken.jsf?cryptoTokenId=" + catoken.getCryptoTokenId() %>">
                <c:out value="<%= cabean.getCryptoTokenName(catoken.getCryptoTokenId()) %>"/>
            </a>
            <% } else { %>
                <c:out value="<%= cabean.getCryptoTokenName(catoken.getCryptoTokenId()) %>"/>
            <% } %>
            </td>	
        </tr>
            <% if (cabean.isCryptoTokenPresent(catoken.getCryptoTokenId())) { %>
        <tr id="Row<%=row%2%>">
            <td width="50%" align="right">defaultKey</td>
                <td><c:out value="<%= catoken.getAliasFromPurpose(CATokenConstants.CAKEYPURPOSE_DEFAULT) %>"/>
            </td>
        </tr>
        <tr id="Row<%=row%2%>">
            <td width="50%" align="right">certSignKey</td>
            <td>
                <c:out value="<%= catoken.getAliasFromPurpose(CATokenConstants.CAKEYPURPOSE_CERTSIGN) %>"/>
            </td>
        </tr>
        <tr id="Row<%=row%2%>">
            <td width="50%" align="right">crlSignKey</td>
            <td>
                <c:out value="<%= catoken.getAliasFromPurpose(CATokenConstants.CAKEYPURPOSE_CRLSIGN) %>"/>
            </td>
        </tr>
        <tr id="Row<%=row%2%>">
            <td width="50%" align="right">keyEncryptKey</td>
            <td>
                <c:out value="<%= catoken.getAliasFromPurpose(CATokenConstants.CAKEYPURPOSE_KEYENCRYPT) %>"/>
            </td>
        </tr>
        <tr id="Row<%=row%2%>">
            <td width="50%" align="right">hardTokenEncrypt</td>
            <td>
                <c:out value="<%= catoken.getAliasFromPurpose(CATokenConstants.CAKEYPURPOSE_HARDTOKENENCRYPT) %>"/>
            </td>
        </tr>
        <tr id="Row<%=row++%2%>">
            <td width="50%" align="right">testKey</td>
            <td>
                <c:out value="<%= catoken.getAliasFromPurpose(CATokenConstants.CAKEYPURPOSE_KEYTEST) %>"/>
            </td>
        </tr>
            <% } %>
        <% } else if (!isexternal) { %>
        <tr id="Row<%=row++%2%>">
            <td width="50%" align="right">
            <strong><%= ejbcawebbean.getText("SIGNINGALGORITHM") %></strong>
            </td>
	        <td>
	        <form name="changecasignalgo" action="<%= THIS_FILENAME %>" method="post">
                <input type="hidden" name="<csrf:tokenname/>" value="<csrf:tokenvalue/>"/>
	            <input type="hidden" name='<%= ACTION %>' value='<%=ACTION_CHOOSE_CASIGNALGO %>'/>
                <input type="hidden" name='<%= hidden_ca_key %>' value='<c:out value="<%= hidden_ca_value %>"/>'/>
	            <input type="hidden" name='<%= HIDDEN_CATYPE %>' value='<c:out value="<%= catype %>"/>'/>
                
	            <select name="<%= SELECT_SIGNATUREALGORITHM %>" size="1" onchange="document.changecasignalgo.submit()">
	            <%
                    for (final String current : AlgorithmConstants.AVAILABLE_SIGALGS) {
                        if (!AlgorithmTools.isSigAlgEnabled(current)) {
                            continue; // e.g. GOST3410 if not configured
                        }
                    	final boolean selectCurrent = current.equals(signatureAlgorithmParam);
                        final String entrySelected = selectCurrent ? "selected" : "";
                        %>
                        <option value='<c:out value="<%= current %>"/>' <%= entrySelected %> ><c:out value="<%= current %>"/></option>  
                <%  } %> 
	            </select>
	            <%/* When JavaScript is not available, we show a "Reload" image. */%>
	            <input id="changecasignalgoUpdateButton" type="image" src="reload.png" alt="Reload"/>
	            <script>document.getElementById('changecasignalgoUpdateButton').style.display = 'none';</script>
            </form>
            </td>	
        </tr>
        <tr id="Row<%=row%2%>">
        	<%	if (cryptoTokenIdParam == null || cryptoTokenIdParam.length()==0 || Integer.parseInt(cryptoTokenIdParam)==0) {
        			row++;		/* For cosmetic. */
        		} %>
            <td width="50%"  align="right"><strong><%= ejbcawebbean.getText("CRYPTOTOKEN") %></strong> <%= ejbcawebbean.getHelpReference("/Managing_Crypto_Tokens.html") %></td>
	        <td>
	        <form name="changecatokentype" action="<%= THIS_FILENAME %>" method="post">
                <input type="hidden" name="<csrf:tokenname/>" value="<csrf:tokenvalue/>"/>
	            <input type="hidden" name='<%= ACTION %>' value='<%=ACTION_CHOOSE_CATOKENTYPE %>'/>
	            <input type="hidden" name='<%= hidden_ca_key %>' value='<c:out value="<%= hidden_ca_value %>"/>'/>
	            <input type="hidden" name='<%= HIDDEN_CATYPE %>' value='<c:out value="<%= catype %>"/>'/>
	            <input type="hidden" name='<%= HIDDEN_CASIGNALGO %>' value='<c:out value="<%= signatureAlgorithmParam %>"/>'/>
            <%  
                final List<Entry<String, String>> availableCryptoTokens = cabean.getAvailableCryptoTokens(signatureAlgorithmParam, editca);
                if (availableCryptoTokens.size()==0) { %>
                    <%= ejbcawebbean.getText("CRYPTOTOKEN_NOSUITABLE") %>
            <%  } else { %>
	            <select name="<%= SELECT_CRYPTOTOKEN %>" size="1" onchange="document.changecatokentype.submit()">
            <%  
                if (editca && isUninitialized && (cryptoTokenIdParam == null || cryptoTokenIdParam.length()==0)) {
                    cryptoTokenIdParam = String.valueOf(catoken.getCryptoTokenId());
                }
                int numSelected = 0; // should be 1 after the loop
                for (final Entry<String, String> entry : availableCryptoTokens) {
                	// Ensure that we have a default for the next section
                	if (cryptoTokenIdParam == null || cryptoTokenIdParam.length()==0) {
                		cryptoTokenIdParam = entry.getKey();
                	}
                	final boolean selectCurrent = entry.getKey().equals(cryptoTokenIdParam);
                    final String entrySelected = selectCurrent ? "selected" : "";
                    numSelected += selectCurrent ? 1 : 0;
                    if (currentCryptoTokenId == 0 || selectCurrent) {
                    	currentCryptoTokenId = Integer.parseInt(entry.getKey());
                    }
            %>
                    <option value="<%=entry.getKey() %>" <%= entrySelected %> ><c:out value="<%= entry.getValue() %>"/></option>
            <%  }
                if (numSelected == 0) { %>
                    <option value="" selected="selected">- <%=ejbcawebbean.getText("CRYPTOTOKEN_MISSING_OR_EMPTY")%> <c:out value="<%= cryptoTokenIdParam %>"/> -</option>
                    <%
                    cryptoTokenIdParam = null;
                    currentCryptoTokenId = 0;
                }
            %>
	            </select>
	            <% if (cryptoTokenIdParam == null && !isUninitialized) { %>
                    <p><strong><%=ejbcawebbean.getText("CRYPTOTOKEN_NEED_EXISTING_OR_GEN")%></strong></p>
                <% } else if (cryptoTokenIdParam == null) { %>
                    <p><strong>You need to select a Crypto Token that exists, or generate keys if it exists, before you can initialize!</strong></p> 
                <% } %>
            <%  } %>
	            <%/* When JavaScript is not available, we show a "Reload" image. */%>
	            <input id="changecatokentypeUpdateButton" type="image" src="reload.png" alt="Reload"/>
                <script>document.getElementById('changecatokentypeUpdateButton').style.display = 'none';</script>
                
                <%  
                    final List<Entry<String, String>> failedCryptoTokens = cabean.getFailedCryptoTokens(signatureAlgorithmParam);
                    if (failedCryptoTokens.size() != 0) {
                        %><p><strong>Failed to access these CryptoTokens:</strong><br /><%
                        for (final Entry<String, String> entry : failedCryptoTokens) {
                            %><a href="<%= ejbcawebbean.getBaseUrl() + globalconfiguration.getAdminWebPath() + "cryptotoken/cryptotoken.jsf?cryptoTokenId=" + entry.getKey() %>"><c:out value="<%= entry.getValue() %>"/></a><br /><% 
                        }
                        %></p><%
                    }
                %>
            </form>
            </td>	
        </tr>
        <% } %>

<%/*was ENCTYPE="post"*/%>
  	 <c:set var="csrf_tokenname"><csrf:tokenname/></c:set>
  	 <c:set var="csrf_tokenvalue"><csrf:tokenvalue/></c:set>
  <form name="ca" method="post" action="<%=THIS_FILENAME %>?${csrf_tokenname}=${csrf_tokenvalue}" enctype='multipart/form-data'>
    <input type="hidden" name='<%= HIDDEN_CACRYPTOTOKEN %>' value='<c:out value="<%= cryptoTokenIdParam %>"/>'>
    <input type="hidden" name='<%= HIDDEN_CASIGNALGO %>' value='<c:out value="<%= signatureAlgorithmParam %>"/>'/>
    <input type="hidden" name='<%= HIDDEN_CATYPE %>' value='<c:out value="<%= catype %>"/>'>
  <%   if (editca && !isUninitialized) { %>  
    <input type="hidden" name='<%= ACTION %>' value='<%=ACTION_EDIT_CA %>'>
    <input type="hidden" name='<%= HIDDEN_CAID %>' value='<c:out value="<%= caid %>"/>'>
    <input type="hidden" name='<%= HIDDEN_CANAME %>' value='<c:out value="<%= cainfo.getName() %>"/>'>
  <%   } else if (editca && isUninitialized) { %>
    <input type="hidden" name='<%= ACTION %>' value='<%=ACTION_EDIT_CA %>'>
    <input type="hidden" name='<%= HIDDEN_CAID %>' value='<c:out value="<%= caid %>"/>'>
    <input type="hidden" name='<%= HIDDEN_CANAME %>' value='<c:out value="<%= cainfo.getName() %>"/>'>
    <% if (extendedServicesKeySpecParam != null) { %><input type="hidden" name='<%= HIDDEN_KEYSIZE %>' value='<c:out value="<%= extendedServicesKeySpecParam %>"/>'><% } %>
  <%   } else { %>
    <input type="hidden" name='<%= ACTION %>' value='<%=ACTION_CREATE_CA %>'>
    <input type="hidden" name='<%= HIDDEN_CANAME %>' value='<c:out value="<%= caname %>"/>'>
    <% }

    
    if (!editca || isUninitialized) {
    	final Map<String, String> aliasUsedMap = new HashMap<String, String>(); 
    	
        /* If there is no available CryptoToken, there is little point in continuing here. */
        if (cryptoTokenIdParam != null && cryptoTokenIdParam.length()>0 && Integer.parseInt(cryptoTokenIdParam)!=0) {
            currentCryptoTokenId = Integer.parseInt(cryptoTokenIdParam);
            
            // Create already in use key map
            for (final String alias : cabean.getAvailableCryptoTokenMixedAliases(currentCryptoTokenId, signatureAlgorithmParam)) {
                final String alreadyInUse = cabean.isKeyInUse(cabean.getAuthorizedCAs(), alias, currentCryptoTokenId) ? " (Already in use)" : StringUtils.EMPTY;
                aliasUsedMap.put(alias, alreadyInUse);
            }
            
    %>
        <tr id="Row<%=row%2%>">
            <td width="50%" align="right">defaultKey</td>
            <td>
	            <select name="<%= SELECT_CRYPTOTOKEN_DEFAULTKEY %>" size="1">
                <%  for (final String alias : cabean.getAvailableCryptoTokenMixedAliases(currentCryptoTokenId, signatureAlgorithmParam)) {
                        final boolean isDefault;
                        if (!editca) {
                            isDefault = CAToken.SOFTPRIVATEDECKEYALIAS.equals(alias) || alias.contains("default") || alias.contains("Default");
                        } else {
                            isDefault = alias.equals(catoken.getAliasFromPurpose(CATokenConstants.CAKEYPURPOSE_DEFAULT));
                        }
                        String selected = isDefault ? "selected=\"selected\" " : "";
                        
                        %>
                        <option <%= selected %>value='<c:out value="<%=alias %>"/>'><c:out value="<%= alias + aliasUsedMap.get(alias) %>"/></option>
                        <%
                    } %>
	            </select>
            </td>	
        </tr>
        <tr id="Row<%=row%2%>">
            <td width="50%" align="right">certSignKey</td>
	        <td>
	            <select name="<%= SELECT_CRYPTOTOKEN_CERTSIGNKEY %>" size="1">
                    <option value=""><%= ejbcawebbean.getText("CRYPTOTOKEN_DEFAULTKEY") %></option>
                <%  for (final String alias : cabean.getAvailableCryptoTokenAliases(currentCryptoTokenId, signatureAlgorithmParam)) {
            	        // If we come accross the (legacy) default signing key alias we use it as selected
            	        final boolean isDefault;
                        if (!editca) {
                            isDefault = CAToken.SOFTPRIVATESIGNKEYALIAS.equals(alias) || alias.contains("sign") || alias.contains("Sign");
                        } else {
                            isDefault = alias.equals(catoken.getAliasFromPurpose(CATokenConstants.CAKEYPURPOSE_CERTSIGN));
                        }
                        String selected = isDefault ? "selected=\"selected\" " : "";
                        
                        %>
                        <option <%= selected %>value='<c:out value="<%=alias %>"/>'><c:out value="<%= alias + aliasUsedMap.get(alias) %>"/></option>
                        <% 
                    } %>
	            </select>
            </td>	
        </tr>
        <tr id="Row<%=row%2%>">
            <td width="50%" align="right">crlSignKey</td><td><%= ejbcawebbean.getText("CRYPTOTOKEN_USECERTSIGN") %></td>
<%/*
            Instead of letting the user select something that will later be unusable, we will just use the same as for the certSignKey.
	        <td>
	            <select name="< %= SELECT_CRYPTOTOKEN_CRLSIGNKEY % >" size="1">
                    <option value="">< %= ejbcawebbean.getText("CRYPTOTOKEN_DEFAULTKEY") % ></option>
                < %  for (final String alias : cabean.getAvailableCryptoTokenAliases(currentCryptoTokenId, signatureAlgorithmParam)) { % >
                <option value='<c:out value="< %=alias % >"/>'><c:out value="< %= alias % >"/></option>
                < %  } % >
	            </select>
            </td>	
*/%>
        </tr>
        <tr id="Row<%=row%2%>">
            <td width="50%" align="right">keyEncryptKey</td>
	        <td>
	            <select name="<%= SELECT_CRYPTOTOKEN_KEYENCRYPTKEY %>" size="1">
                    <option value=""><%= ejbcawebbean.getText("CRYPTOTOKEN_DEFAULTKEY") %></option>
                <%  for (final String alias : cabean.getAvailableCryptoTokenEncryptionAliases(currentCryptoTokenId, signatureAlgorithmParam)) { 

                %>
                
                        <option <%= editca && alias.equals(catoken.getAliasFromPurpose(CATokenConstants.CAKEYPURPOSE_KEYENCRYPT)) ? "selected=\"selected\" " : "" %>
                          value='<c:out value="<%=alias %>"/>'><c:out value="<%= alias + aliasUsedMap.get(alias) %>"/></option>
                <%  } %>
	            </select>
            </td>	
        </tr>
        <tr id="Row<%=row%2%>">
            <td width="50%" align="right">hardTokenEncrypt</td>
	        <td>
	            <select name="<%= SELECT_CRYPTOTOKEN_HARDTOKENENCRYPTKEY %>" size="1">
                    <option value=""><%= ejbcawebbean.getText("CRYPTOTOKEN_DEFAULTKEY") %></option>
                <%  for (final String alias : cabean.getAvailableCryptoTokenEncryptionAliases(currentCryptoTokenId, signatureAlgorithmParam)) { 
                
                %>
                    <option <%= editca && alias.equals(catoken.getAliasFromPurpose(CATokenConstants.CAKEYPURPOSE_HARDTOKENENCRYPT)) ? "selected=\"selected\" " : "" %>
                          value='<c:out value="<%=alias %>"/>'><c:out value="<%= alias + aliasUsedMap.get(alias) %>"/></option>
                <%  } %>
	            </select>
            </td>
        </tr>
        <tr id="Row<%=row++%2%>">
            <td width="50%" align="right">testKey</td>
	        <td>
	            <select name="<%= SELECT_CRYPTOTOKEN_KEYTESTKEY %>" size="1">
                    <option value=""><%= ejbcawebbean.getText("CRYPTOTOKEN_DEFAULTKEY") %></option>
                <%  for (final String alias : cabean.getAvailableCryptoTokenAliases(currentCryptoTokenId, signatureAlgorithmParam)) {
                        final boolean isDefault;
                        if (!editca) {
                            isDefault = alias.contains("test") || alias.contains("Test");
                        } else {
                            isDefault = alias.equals(catoken.getAliasFromPurpose(CATokenConstants.CAKEYPURPOSE_KEYTEST));
                        }
                        String selected = isDefault ? "selected=\"selected\" " : "";
                        
                        %>
                        <option <%= selected %>value='<c:out value="<%=alias %>"/>'><c:out value="<%= alias + aliasUsedMap.get(alias) %>"/></option>
                        <% 
                    } %>
	            </select>
            </td>
        </tr>
        <tr id="Row<%=row++%2%>"> 
            <td width="50%"  align="right">
                <%= ejbcawebbean.getText("EXTSERVICESKEYSPEC") %> <%= ejbcawebbean.getHelpReference("/CA_Fields.html#Extended_Services_Key_Specification") %>
            </td>
            <td width="50%"> 
                <select name="<%= SELECT_KEYSIZE %>" size="1" <%= (hasEditRights ? "" : "disabled") %>>
                <%  if (extendedServicesKeySpecParam == null) {
                        extendedServicesKeySpecParam = "2048";
                    }
                    for (final Entry<String,String> entry : cabean.getAvailableKeySpecs()) {
                        final String selectedEntry = entry.getKey().equals(extendedServicesKeySpecParam) ? " selected " : ""; %>
                        <option value="<%= entry.getKey() %>"<%= selectedEntry %>><%= entry.getValue() %></option>  
                <%  } %>
                </select>
            </td>
        </tr>
    <%  } %>
    
  <%   } %>

    <% if (!editca || cabean.isCryptoTokenPresent(catoken.getCryptoTokenId())) { %>
      <tr id="Row<%=row%2%>"> 
        <td width="50%"  align="right">
          <%= ejbcawebbean.getText("KEYSEQUENCEFORMAT") %> <%= ejbcawebbean.getHelpReference("/CA_Fields.html#Key_Sequence_Format") %>
        </td>
        <td width="50%" valign="top">
            <select name="<%=SELECT_KEY_SEQUENCE_FORMAT %>" size="1" <%= (hasEditRights ? "" : "disabled") %>>                
                 <option value="<%=StringTools.KEY_SEQUENCE_FORMAT_NUMERIC%>" <%if(keySequenceFormat == StringTools.KEY_SEQUENCE_FORMAT_NUMERIC) out.write("selected");%>><%=ejbcawebbean.getText("NUMERIC")%></option>
                 <option value="<%=StringTools.KEY_SEQUENCE_FORMAT_ALPHANUMERIC%>" <%if(keySequenceFormat == StringTools.KEY_SEQUENCE_FORMAT_ALPHANUMERIC) out.write("selected");%>><%=ejbcawebbean.getText("ALPHANUMERIC")%></option>
                 <option value="<%=StringTools.KEY_SEQUENCE_FORMAT_COUNTRY_CODE_PLUS_NUMERIC%>" <%if(keySequenceFormat == StringTools.KEY_SEQUENCE_FORMAT_COUNTRY_CODE_PLUS_NUMERIC) out.write("selected");%>><%=ejbcawebbean.getText("COUNTRYCODEPLUSNUMERIC")%></option>
                 <option value="<%=StringTools.KEY_SEQUENCE_FORMAT_COUNTRY_CODE_PLUS_ALPHANUMERIC%>" <%if(keySequenceFormat == StringTools.KEY_SEQUENCE_FORMAT_COUNTRY_CODE_PLUS_ALPHANUMERIC) out.write("selected");%>><%=ejbcawebbean.getText("COUNTRYCODEPLUSALPHANUMERIC")%></option>
	        </select> 
        </td>
      </tr>

    <tr id="Row<%=row++%2%>">
      <td width="50%"  align="right"> 
        <%= ejbcawebbean.getText("KEYSEQUENCE") %> <%= ejbcawebbean.getHelpReference("/CA_Fields.html#Key_Sequence") %>
      </td>
      <td width="50%"> 
        <% String sequence = CAToken.DEFAULT_KEYSEQUENCE;
           if (catoken != null) {
        	   sequence = catoken.getKeySequence();
           } %>
        <input type="text" name="<%=TEXTFIELD_KEYSEQUENCE%>" size="6" <% out.write(" value='"+sequence+"'"); %> maxlength="10" <%= (hasEditRights ? "" : "disabled") %>>
      </td>
    </tr>
    <% } %>

    <tr id="Row<%=row%2%>"> 
      <td width="50%"  align="right"> 
        <%= ejbcawebbean.getText("DESCRIPTION") %>
      </td>
      <td width="50%"> 
        <% if(isexternal){ %>
              <c:out value="<%= cainfo.getDescription() %>"/>
         <% }else{ %>
        <textarea name="<%=TEXTFIELD_DESCRIPTION%>" cols="45" rows="2" <%= (hasEditRights ? "" : "disabled") %>><% if(editca) { %><c:out value="<%= cainfo.getDescription() %>"/><% } %></textarea>
       <% } %>
      </td>
    </tr>

    <%-- ---------- Directives -------------------- --%>

    <% if (!isexternal) { %>
    <tr  id="Row<%=row++%2%>" class="section"> 
      <td width="50%"  align="right"> 
        <strong><%= ejbcawebbean.getText("DIRECTIVES") %></strong>
      </td>
      <td width="50%"> 
        &nbsp;
      </td>
    </tr>

    <tr id="Row<%=row++%2%>"> 
      <td width="50%"  align="right"> 
        <%= ejbcawebbean.getText("DOENFORCEUNIQUEPUBLICKEYS") %>
        <%= ejbcawebbean.getHelpReference("/CA_Fields.html#Enforce_unique_public_keys") %> <br />
      </td>
      <td width="50%">
        <input type="checkbox" name="<%=CHECKBOX_DOENFORCEUNIQUEPUBLICKEYS %>" value="<%=CHECKBOX_VALUE %>" 
            <% if((editca && cainfo.isDoEnforceUniquePublicKeys()) || !editca)
                 out.write("CHECKED");%> id="<%=CHECKBOX_DOENFORCEUNIQUEPUBLICKEYS%>" <%= (hasEditRights ? "" : "disabled") %>>
                 <label for="<%=CHECKBOX_DOENFORCEUNIQUEPUBLICKEYS%>"><c:out value="<%= ejbcawebbean.getText(\"ENFORCE\") %>" /></label>         
      </td>
    </tr>

    <tr id="Row<%=row++%2%>">
      <td width="50%"  align="right"> 
        <%= ejbcawebbean.getText("DOENFORCEUNIQUEDN") %>
        <%= ejbcawebbean.getHelpReference("/CA_Fields.html#Enforce_unique_DN") %> <br />
      </td>
      <td width="50%"> 
        <input type="checkbox" name="<%=CHECKBOX_DOENFORCEUNIQUEDN %>" value="<%=CHECKBOX_VALUE %>" 
            <% if((editca && cainfo.isDoEnforceUniqueDistinguishedName()) || !editca)
                 out.write("CHECKED");%> id="<%=CHECKBOX_DOENFORCEUNIQUEDN%>" <%= (hasEditRights ? "" : "disabled") %>>
                 <label for="<%=CHECKBOX_DOENFORCEUNIQUEDN%>"><c:out value="<%= ejbcawebbean.getText(\"ENFORCE\") %>" /></label>  
      </td>
    </tr>

    <tr id="Row<%=row++%2%>">
      <td width="50%"  align="right"> 
        <%= ejbcawebbean.getText("DOENFORCEUNIQUESUBJECTDNSERIALNUMBER") %>
        <%= ejbcawebbean.getHelpReference("/CA_Fields.html#Enforce_Unique_Subject_DN_SerialNumber") %> <br />
      </td>
      <td width="50%"> 
        <input type="checkbox" name="<%=CHECKBOX_DOENFORCEUNIQUESUBJECTDNSERIALNUMBER %>" value="<%=CHECKBOX_VALUE %>" 
            <% if((editca && cainfo.isDoEnforceUniqueSubjectDNSerialnumber()))
                 out.write("CHECKED");%> id="<%=CHECKBOX_DOENFORCEUNIQUESUBJECTDNSERIALNUMBER%>" <%= (hasEditRights ? "" : "disabled") %>>
                 <label for="<%=CHECKBOX_DOENFORCEUNIQUESUBJECTDNSERIALNUMBER%>"><c:out value="<%= ejbcawebbean.getText(\"ENFORCE\") %>" /></label>         
      </td>
    </tr>

    <tr id="Row<%=row++%2%>">
      <td width="50%"  align="right"> 
        <%= ejbcawebbean.getText("USECERTREQHISTORY") %>
        <%= ejbcawebbean.getHelpReference("/CA_Fields.html#Use_Certificate_Request_History") %> <br />
      </td>
      <td width="50%"> 
        <input type="checkbox" name="<%=CHECKBOX_USECERTREQHISTORY %>" value="<%=CHECKBOX_VALUE %>" 
            <% if(editca && cainfo.isUseCertReqHistory())
                 out.write("CHECKED");%> id="<%=CHECKBOX_USECERTREQHISTORY%>" <%= (hasEditRights ? "" : "disabled") %>>         
               <label for="<%=CHECKBOX_USECERTREQHISTORY%>"><c:out value="<%= ejbcawebbean.getText(\"USE\") %>" /></label>
      </td>
    </tr>

    <tr id="Row<%=row++%2%>">
      <td width="50%"  align="right"> 
        <%= ejbcawebbean.getText("USEUSERSTORAGE") %>
        <%= ejbcawebbean.getHelpReference("/CA_Fields.html#Use_User_Storage") %> <br />
      </td>
      <td width="50%"> 
        <input type="checkbox" name="<%=CHECKBOX_USEUSERSTORAGE %>" value="<%=CHECKBOX_VALUE %>" 
            <% if(editca) {
            	  if (cainfo.isUseUserStorage()) out.write("CHECKED"); // edit CA
               } else {
            	  out.write("CHECKED"); // new CA default to true
               }%> id="<%=CHECKBOX_USEUSERSTORAGE%>" <%= (hasEditRights ? "" : "disabled") %>>
               <label for="<%=CHECKBOX_USEUSERSTORAGE%>"><c:out value="<%= ejbcawebbean.getText(\"USE\") %>" /></label>     
      </td>
    </tr>

    <tr id="Row<%=row%2%>">
      <td width="50%"  align="right"> 
        <%= ejbcawebbean.getText("USECERTIFICATESTORAGE") %>
        <%= ejbcawebbean.getHelpReference("/CA_Fields.html#Use_Certificate_Storage") %> <br />
      </td>
      <td width="50%"> 
        <input type="checkbox" name="<%=CHECKBOX_USECERTIFICATESTORAGE %>" value="<%=CHECKBOX_VALUE %>" onclick="hideShowThrowAwayCAItems();checkAcceptNonExistingEntries();selectDefaultCertificateProfile();updateCertificateDataTableToUseFieldStatus();"
            <% if(editca) {
            	  if (cainfo.isUseCertificateStorage()) out.write("CHECKED"); // edit CA
               } else {
            	  out.write("CHECKED"); // new CA default to true
               }%> id="<%=CHECKBOX_USECERTIFICATESTORAGE%>" <%= (hasEditRights ? "" : "disabled") %>>
               <label for="<%=CHECKBOX_USECERTIFICATESTORAGE%>"><c:out value="<%= ejbcawebbean.getText(\"USE\") %>" />...</label>      
      </td>
    </tr>
    
    <% if (catype == CAInfo.CATYPE_X509) { %>
      <tr id="Row<%=row%2%>" class="onlyShowForThrowAwayCA">
          <td width="50%"  align="right">
              <%= ejbcawebbean.getText("ACCEPTREVOCATIONSNONEXISTINGENTRY") %> <%= ejbcawebbean.getHelpReference("/CA_Fields.html#Accept_Revocations_of_Non-Existing_Entries") %><br />
          </td>
          <td width="50%">
              <input type="checkbox" name="<%=CHECKBOX_ACCEPTREVOCATIONSNONEXISTINGENTRY %>" value="<%=CHECKBOX_VALUE %>" onchange="selectDefaultCertificateProfile();updateCertificateDataTableToUseFieldStatus();"
                  <% if(editca && cainfo.isAcceptRevocationNonExistingEntry()) {
                      out.write("CHECKED"); // edit CA
                      acceptRevocationsNonExistingEntries = true;
               }
               %>
                     id="<%=CHECKBOX_ACCEPTREVOCATIONSNONEXISTINGENTRY%>" <%= (!hasEditRights || !editca || cainfo.isUseCertificateStorage() ? "disabled" : "") %>>
              <label for="<%=CHECKBOX_ACCEPTREVOCATIONSNONEXISTINGENTRY%>"><c:out value="<%= ejbcawebbean.getText(\"ACCEPT\") %>" /></label>
          </td>
      </tr>
      <tr id="Row<%=row%2%>" class="onlyShowForThrowAwayCA">
        <td width="50%" align="right"><%= ejbcawebbean.getText("CERTIFICATEPROFILEFORNONEXISTING")%> <%= ejbcawebbean.getHelpReference("/CA_Fields.html#Default_Certificate_Profile_for_Non-Existing_Entries") %></td>
        <td>
            <% boolean isDefaultProfileDisabled = !hasEditRights || !editca || cainfo.isUseCertificateStorage() || !acceptRevocationsNonExistingEntries; %>
          <select name="<%=SELECT_DEFAULTCERTPROFILE %>" size="1" <%= (isDefaultProfileDisabled  ? "disabled" : "") %> >
              <% TreeMap allp = ejbcawebbean.getAuthorizedEndEntityCertificateProfileNames();
                  Iterator iter = allp.keySet().iterator();
                  String currentCertProfileId = editca ? String.valueOf(cainfo.getDefaultCertificateProfileId()) : "" ;
                  while(iter.hasNext()){
                      String nextprofilename = (String) iter.next();
                      int certprofid = ((Integer) allp.get(nextprofilename)).intValue();%>
              <option value="<c:out value="<%= certprofid %>"/>"
                      <% if(editca && Integer.toString(certprofid).equals(currentCertProfileId)) { %> selected <%}%>
              ><c:out value="<%= nextprofilename %>"/></option>
              <% } %>
          </select>
        </td>
      </tr>
      
      
     <tr id="Row<%=row++%2%>" class="onlyShowForThrowAwayCA">
        <td width="50%" align="right"><%= ejbcawebbean.getText("USEAPPENDONLYTABLE")%> <%= ejbcawebbean.getHelpReference("/CA_Fields.html#Use_Append-Only_Table") %></td>
        <td>
          <input type="checkbox" name="<%=CHECKBOX_USEAPPENDONLYTABLE %>" value="<%=CHECKBOX_VALUE %>" 
	          <% if(editca && cainfo.isUseNoConflictCertificateData()) { out.write("CHECKED"); } %>  
    	           id="<%=CHECKBOX_USEAPPENDONLYTABLE%>" <%= (!hasEditRights || !editca || cainfo.isUseCertificateStorage() || !acceptRevocationsNonExistingEntries ? "disabled" : "") %>>
              <label for="<%=CHECKBOX_USEAPPENDONLYTABLE%>"><c:out value="<%= ejbcawebbean.getText(\"USE\") %>" /></label>
        </td>
      </tr>
	  <% } /* end if X509 CA */  %>
    <% } /* end if not external CA*/ %>

    <%-- ---------- CA certificate data -------------------- --%>

    <tr id="Row<%=row++%2%>" class="section">
        <td width="50%"  align="right">
        <strong><%= ejbcawebbean.getText("CACERTIFICATEDATA") %></strong></td>
        <td width="50%">&nbsp;</td>
    </tr>
    
    <tr id="Row<%=row++%2%>"> 
      <td width="50%"  align="right"> 
        <strong><%= ejbcawebbean.getText("CERT_SUBJECTDN") %></strong>
      </td>
      <td width="50%"> 
        <% if (editca && !isUninitialized) { %>
              <span class="dn"><c:out value="<%= cainfo.getSubjectDN() %>"/></span>
        <% } else if (editca && isUninitialized) { %>  
             <input type="text" name="<%=TEXTFIELD_SUBJECTDN%>" size="45" maxlength="225" value="<c:out value="<%= cainfo.getSubjectDN() %>"/>" title="<%= ejbcawebbean.getText("FORMAT_DN") %>" 
             	<%= (hasEditRights ? "" : "disabled") %> >
          <% } else { %>
        <% /* Maxlength for the CA subject DN is based on 250 chars MySQL String mapping minus the "CN=xxxxSignerCertificate," string that is added for services. */ %>
        <input type="obligatory" name="<%=TEXTFIELD_SUBJECTDN%>" id="<%=TEXTFIELD_SUBJECTDN%>" size="45" maxlength="225" value="CN=<c:out value="<%= caname %>"/>" title="<%= ejbcawebbean.getText("FORMAT_DN") %>"
        	<%= (hasEditRights ? "" : "disabled") %> >
        <% } %>
      </td>
    </tr>

    <% if(editca && !isUninitialized){
        String issuerDN = "unknown";
        try {
            Collection cachain = cainfo.getCertificateChain();
            if (cachain != null) {
    	        Iterator iter = cachain.iterator();
    	        Certificate cacert = (Certificate)iter.next();
        	    issuerDN = CertTools.getIssuerDN(cacert);
            }
        } catch (Exception e) {
        	// En error happended
        	issuerDN = e.getMessage();
        }
    %>
        <tr id="Row<%=row++%2%>"> 
          <td width="50%"  align="right"> 
            <%= ejbcawebbean.getText("CERT_ISSUERDN") %>
          </td>
          <td width="50%">
              <span class="dn"><c:out value="<%= issuerDN %>"/></span>
          </td>
        </tr>
    <% } %>

    <tr id="Row<%=row++%2%>"> 
        <td width="50%"  align="right"><%= ejbcawebbean.getText("SIGNEDBY") %></td>
        <td width="50%">
        <%  if (editca && !isUninitialized) {
                if (cainfo.getSignedBy() >= 0 && cainfo.getSignedBy() <= CAInfo.SPECIALCAIDBORDER) {
                    if (cainfo.getSignedBy() == CAInfo.SELFSIGNED) {
                        out.write(ejbcawebbean.getText("SELFSIGNED"));
                    }
                    if (cainfo.getSignedBy() == CAInfo.SIGNEDBYEXTERNALCA) {
                        out.write(ejbcawebbean.getText("SIGNEDBYEXTERNALCA"));
                    }
                } else {
                    out.write((String) caidtonamemap.get(Integer.valueOf(cainfo.getSignedBy())));
                }
            } else if (editca && isUninitialized) { %>  
                <select name="<%=SELECT_SIGNEDBY %>" size="1" onchange="fillCertProfileField(); isExternalX509(); isExternalGeneric()" <%= (hasEditRights ? "" : "disabled") %>>
                <option value="<%= CAInfo.SELFSIGNED%>" <% if(cainfo.getSignedBy() == CAInfo.SELFSIGNED) { %>selected <% } %> >
                  <%= ejbcawebbean.getText("SELFSIGNED") %>
                </option>  
                <option value="<%= CAInfo.SIGNEDBYEXTERNALCA%>" <% if(cainfo.getSignedBy() == CAInfo.SIGNEDBYEXTERNALCA) { %>selected <% } %> >
                  <%= ejbcawebbean.getText("EXTERNALCA") %>
                </option>  
                <% for (final Object nameOfCa : casigners.keySet()) {
                     int entryId = casigners.get(nameOfCa.toString());
                     if (entryId == cainfo.getCAId()) { continue; }
                     %>
                     <option value="<%= entryId %>" <% if(cainfo.getSignedBy() == entryId) { %>selected <% } %> > 
                         <c:out value="<%= nameOfCa.toString() %>"/>
                     </option>
                <% } %> 
            </select>
         <% } else { %>
            <select name="<%=SELECT_SIGNEDBY %>" size="1" onchange="fillCertProfileField(); isExternalX509(); isExternalGeneric()" <%= (hasEditRights ? "" : "disabled") %>>
                <option value="<%= CAInfo.SELFSIGNED%>" selected><%= ejbcawebbean.getText("SELFSIGNED") %></option>  
                <option value="<%= CAInfo.SIGNEDBYEXTERNALCA%>"><%= ejbcawebbean.getText("EXTERNALCA") %></option>  
                <% for (final Object nameOfCa : casigners.keySet()) { %>
                     <option value="<%= casigners.get(nameOfCa.toString())%>"><c:out value="<%= nameOfCa.toString() %>"/></option>  
                <% } %> 
            </select>
        <%  } %> 
      </td>
    </tr>

        <tr id="Row<%=row++%2%>">
            <td width="50%" align="right"><%= ejbcawebbean.getText("CERTIFICATEPROFILE")%></td>
            <td>
                <% if (editca && !isUninitialized) {
                    if (cainfo.getCertificateProfileId() != 0) {
                        %><c:out value="<%= ejbcawebbean.getCertificateProfileName(cainfo.getCertificateProfileId()) %>"/> <%
                    } else {
                        out.write(ejbcawebbean.getText("NOTUSED"));
                    }
                 } else if (editca && isUninitialized)  {
                    String currentCertProfileId = String.valueOf(cainfo.getCertificateProfileId()); %>
                    <select name="<%= SELECT_CERTIFICATEPROFILE %>" size="1" <%= (hasEditRights ? "" : "disabled") %>>
                    <%  for (final Entry<String,String> entry : cabean.getAvailableCaCertificateProfiles()) { %>
                            <option value="<%=entry.getKey() %>" <% if(entry.getKey().equals(currentCertProfileId)) { %> selected <%}%>>
                                <c:out value="<%= entry.getValue() %>"/>
                            </option>
                    <%  } %>
                 </select>
                 <%  } else{ %>
	                <select name="<%= SELECT_CERTIFICATEPROFILE %>" size="1" <%= (hasEditRights ? "" : "disabled") %>>
                    <%  for (final Entry<String,String> entry : cabean.getAvailableCaCertificateProfiles()) { %>
                            <option value="<%=entry.getKey() %>"><c:out value="<%= entry.getValue() %>"/></option>
                    <%  } %>
	                </select>
                <% } %> 
            </td>	
        </tr>

    <% if (!isexternal) { %>
    <tr id="Row<%=row++%2%>"> 
      <td width="50%"  align="right"> 
        <strong><%= ejbcawebbean.getText("CERT_VALIDITY") %></strong> <%= ejbcawebbean.getText("FORMAT_TIME_YMODHMS") %> <%= ejbcawebbean.getText("ORENDDATE") %>
        <%= ejbcawebbean.getHelpReference("/Certificate_Profile_Fields.html#validity") %> <br />
      </td>
      <td width="50%"> 
        <% if(isexternal || (editca && !isUninitialized && signbyexternal)){
        	  if (StringUtils.isNotBlank( cainfo.getEncodedValidity())) {
                out.write(cainfo.getEncodedValidity());
              } else {
                out.write(ejbcawebbean.getText("NOTUSED"));
              }
              
           }else{ %>
        <input type="obligatory" name="<%=TEXTFIELD_VALIDITY%>" id="<%=TEXTFIELD_VALIDITY%>" size="25" maxlength="255" title="<%= ejbcawebbean.getText("FORMAT_TIME_YMODHMS") %> <%= ejbcawebbean.getText("OR") %> <%= ejbcawebbean.getText("FORMAT_ISO8601") %>"
           <% if(editca) out.write("value=\"" + cainfo.getEncodedValidity() + "\""); %> <%= (hasEditRights ? "" : "disabled") %> />
           <% if(editca) { %>
        &nbsp;
        <span class="help"><%= ejbcawebbean.getText("CERT_VALIDITY_CA_HELP") %></span>
           <% } %>
        <% } %>
        <p class="help"><%= ejbcawebbean.getText("DATE_HELP") %> <%= ejbcawebbean.getDateExample() %>. <%= ejbcawebbean.getText("YEAR365DAYS") + ", " + ejbcawebbean.getText("MO30DAYS") %>.</p>
      </td>
    </tr>
    <% } %>

    <% if (catype == CAInfo.CATYPE_X509) { 
	     X509CAInfo x509cainfo = (X509CAInfo) cainfo;
        %>

    <tr  id="Row<%=row++%2%>"> 
      <td width="50%"  align="right"> 
        <%= ejbcawebbean.getText("EXT_PKIX_SUBJECTALTNAME") %>
      </td>
      <td width="50%">
         <% if (editca && !isUninitialized) {
              if(x509cainfo.getSubjectAltName() == null || x509cainfo.getSubjectAltName().trim().equals("")) {
                out.write(ejbcawebbean.getText("NONE")); 
              } else { %>
                <c:out value="<%= x509cainfo.getSubjectAltName() %>"/>
              <% }
            } else { %>
         <input type="text" name="<%=TEXTFIELD_SUBJECTALTNAME%>" size="45" maxlength="255" title="<%= ejbcawebbean.getText("FORMAT_GENERALNAMES") %>"
             value="<c:out value="<%= isUninitialized ? x509cainfo.getSubjectAltName() : \"\" %>"/>" <%= (hasEditRights ? "" : "disabled") %> />
         <% } %>
      </td>
    </tr> 

    <tr  id="Row<%=row++%2%>"> 
      <td width="50%"  align="right"> 
        <strong><%= ejbcawebbean.getText("EXT_PKIX_CP_POLICYID") %></strong>
      </td>
      <td width="50%">
         <% if (editca && !isUninitialized) {
              if(x509cainfo.getPolicies() == null || (x509cainfo.getPolicies().size() == 0)) {
                 out.write(ejbcawebbean.getText("NONE")); 
              } else {
                // Some special handling to handle the upgrade case after CertificatePolicy changed classname
                String policyId = null;
                Object o = x509cainfo.getPolicies().get(0);
                if (o instanceof CertificatePolicy) {
                  policyId = ((CertificatePolicy)o).getPolicyID(); 
                } else {
                  policyId = ((org.ejbca.core.model.ca.certificateprofiles.CertificatePolicy)o).getPolicyID();
                }
                if (policyId == null) {
                  out.write(ejbcawebbean.getText("NONE")); 
                } else { 
                  out.write(policyId);
                }
              }
            } else {
                String policies = "";
                if (isUninitialized) {
                    List<CertificatePolicy> list = x509cainfo.getPolicies();
                    CertificatePolicy cp = (list != null && list.size() >= 1) ? list.get(0) : null;
                    if (cp != null) {
                        policies += cp.getPolicyID();
                        if (cp.getQualifier() != null) {
                            policies += " "+cp.getQualifier();
                        }
                    }
                }
                %>
             <input type="text" name="<%=TEXTFIELD_POLICYID%>" size="20" maxlength="255" title="<%= ejbcawebbean.getText("FORMAT_OID") %>" value="<c:out value="<%= policies  %>"/>"
             	<%= (hasEditRights ? "" : "disabled") %>/>
         <% } %>
         <% if(!editca || isUninitialized) out.write("<p class=\"help\">" + ejbcawebbean.getText("EXT_PKIX_CP_POLICYID_HELP") + "</p>"); %>
      </td>
    </tr> 

    <!-- NOTE: External CAs does not have any settings at all basically, we just import the certificate. -->
    <% if (!isexternal) { %>

    <tr id="Row<%=row++%2%>"> 
      <td width="50%"  align="right"> 
        <%= ejbcawebbean.getText("EXT_PKIX_CP_UTF8NOTICETEXT") %>
      </td>
      <td width="50%"> 
        <input type="checkbox" name="<%=CHECKBOX_USEUTF8POLICYTEXT %>" value="<%=CHECKBOX_VALUE %>" 
            <% if((editca && x509cainfo.getUseUTF8PolicyText()))
                 out.write("CHECKED");%> id="<%=CHECKBOX_USEUTF8POLICYTEXT%>" <%= (hasEditRights ? "" : "disabled") %>>
            <label for="<%=CHECKBOX_USEUTF8POLICYTEXT%>"><c:out value="<%= ejbcawebbean.getText(\"USE\") %>" /></label>       
      </td>
    </tr>

    <tr id="Row<%=row++%2%>"> 
      <td width="50%"  align="right"> 
        <%= ejbcawebbean.getText("CERT_SUBJECTDN_PRINTABLESTR") %>
      </td>
      <td width="50%"> 
        <input type="checkbox" name="<%=CHECKBOX_USEPRINTABLESTRINGSUBJECTDN %>" value="<%=CHECKBOX_VALUE %>" 
            <% if((editca && x509cainfo.getUsePrintableStringSubjectDN()))
                 out.write("CHECKED");%> id="<%=CHECKBOX_USEPRINTABLESTRINGSUBJECTDN%>" <%= (hasEditRights ? "" : "disabled") %>>
             <label for="<%=CHECKBOX_USEPRINTABLESTRINGSUBJECTDN%>"><c:out value="<%= ejbcawebbean.getText(\"USE\") %>" /></label>      
      </td>
    </tr>

    <tr id="Row<%=row++%2%>"> 
      <td width="50%"  align="right"> 
        <strong><%= ejbcawebbean.getText("CERT_SUBJECTDN_LDAPORDER") %></strong> <%= ejbcawebbean.getHelpReference("/Certificate_Profile_Fields.html#Use_LDAP_DN_Order") %>
      </td>
      <td width="50%"> 
        <input type="checkbox" name="<%=CHECKBOX_USELDAPDNORDER %>" value="<%=CHECKBOX_VALUE %>" 
            <% if ( (editca && x509cainfo.getUseLdapDnOrder()) || (!editca) ) // default value when createCA = true (checked)
                 out.write("CHECKED");%> id="<%=CHECKBOX_USELDAPDNORDER%>" <%= (hasEditRights ? "" : "disabled") %>>
             <label for="<%=CHECKBOX_USELDAPDNORDER%>"><c:out value="<%= ejbcawebbean.getText(\"USE\") %>" /></label>      
      </td>
    </tr>

    <%
    String nameConstraintsPermittedString = !editca ? "" : NameConstraint.formatNameConstraintsList(x509cainfo.getNameConstraintsPermitted());
    String nameConstraintsExcludedString = !editca ? "" : NameConstraint.formatNameConstraintsList(x509cainfo.getNameConstraintsExcluded());
    %>
    <tr id="Row<%=row%2%>">
      <td width="50%"  align="right">
        <%= ejbcawebbean.getText("EXT_PKIX_NC_PERMITTED") %>
        <%= ejbcawebbean.getHelpReference("/CA_Fields.html#Name_Constraints") %>
      </td>
      <td width="50%">
        <%-- Do not put the c:out on a separate line, because that will add extra whitespace in the textarea --%>
        <textarea name="<%=TEXTFIELD_NAMECONSTRAINTSPERMITTED%>" rows="4" cols="38" <%= (hasEditRights ? "" : "disabled") %>><c:out value="<%= nameConstraintsPermittedString %>"/></textarea>
        <p class="help"><c:out value="<%= ejbcawebbean.getText(\"EXT_PKIX_NC_PERMITTED_HELP1\") %>" /><br />
        <c:out value="<%= ejbcawebbean.getText(\"EXT_PKIX_NC_PERMITTED_HELP2\") %>" /></p>
      </td>
    </tr>
    <tr id="Row<%=row++%2%>">
      <td width="50%"  align="right">
        <%= ejbcawebbean.getText("EXT_PKIX_NC_EXCLUDED") %>
        <%= ejbcawebbean.getHelpReference("/CA_Fields.html#Name_Constraints") %>
      </td>
      <td width="50%">
        <%-- Do not put the c:out on a separate line, because that will add extra whitespace in the textarea --%>
        <textarea name="<%=TEXTFIELD_NAMECONSTRAINTSEXCLUDED%>" rows="4" cols="38" <%= (hasEditRights ? "" : "disabled") %>><c:out value="<%= nameConstraintsExcludedString %>"/></textarea>
        <p class="help"><c:out value="<%= ejbcawebbean.getText(\"EXT_PKIX_NC_EXCLUDED_HELP\") %>" /></p>
      </td>
    </tr>

    <% } // if (!isexternal) %>

    <% if (editca && !waitingresponse && !isUninitialized) { %>
    <tr id="Row<%=row++%2%>">
        <td width="50%" align="right"><strong><c:out value='<%= ejbcawebbean.getText("CACERTIFICATE") %>' /></strong></td>
        <td width="50%"><button type='button' onclick='viewcacert()' title='<%= ejbcawebbean.getText("VIEW_CACERTIFICATE_TITLE") %> <%= ejbcawebbean.getText("POPUP_WINDOW") %>'><c:out value='<%= ejbcawebbean.getText("VIEW_CERTIFICATE") %>' /></button></td>
    </tr>
    <% } %>

    <%-- ---------- CRL Specific Data -------------------- --%>

    <tr  id="Row<%=row++%2%>" class="section"> 
      <td width="50%"  align="right"> 
        <strong><%= ejbcawebbean.getText("CRLSPECIFICDATA") %></strong>
      </td>
      <td width="50%"> 
        &nbsp;
      </td>
    </tr>

    <% if (isexternal && catype==CAInfo.CATYPE_X509) { %>
    <tr id="Row<%=row++%2%>"> 
      <td width="50%"  align="right">
         <%= ejbcawebbean.getText("CRL_CA_CRLDP_EXTERNAL") %>
      </td>
      <td width="50%">
         <input type="text" name="<%=TEXTFIELD_EXTERNALCDP%>" size="40" maxlength="255"
        	 <% if (editca) {%>value="<c:out value="<%= x509cainfo.getExternalCdp() %>"/>"<%}%> <%= (hasEditRights ? "" : "disabled") %> >
      </td>
    </tr>
    <% } %>

    <!-- NOTE: External CAs does not have any settings at all basically, we just import the certificate. -->
    <!--       If we are processing a request we are issuing certificate to an external CA and we can not set CRL stuff for that CA. -->
    <% if (!isexternal) { %>

    <tr  id="Row<%=row++%2%>"> 
      <td width="50%"  align="right"> 
         <%= ejbcawebbean.getText("CRL_EXT_AUTHORITYKEYID") %>
      </td>
      <td width="50%">
           <input type="checkbox" name="<%=CHECKBOX_AUTHORITYKEYIDENTIFIER %>" onClick="checkusefield('<%=CHECKBOX_AUTHORITYKEYIDENTIFIER %>', '<%=CHECKBOX_AUTHORITYKEYIDENTIFIERCRITICAL %>')" value="<%=CHECKBOX_VALUE %>" 
          	 <% if((editca && x509cainfo.getUseAuthorityKeyIdentifier()) || !editca)
            	     out.write("CHECKED");
          	    if(isexternal) out.write(" disabled ");
         	  %> id="<%=CHECKBOX_AUTHORITYKEYIDENTIFIER%>" <%= (hasEditRights ? "" : "disabled") %>>
           <label for="<%=CHECKBOX_AUTHORITYKEYIDENTIFIER%>"><c:out value="<%= ejbcawebbean.getText(\"USE\") %>" /></label>
           &nbsp;
          <input type="checkbox" name="<%=CHECKBOX_AUTHORITYKEYIDENTIFIERCRITICAL %>" value="<%=CHECKBOX_VALUE %>" 
           <%
             if(editca){
               if(!x509cainfo.getUseAuthorityKeyIdentifier() || isexternal)
                 out.write(" disabled ");  
               else
               if(x509cainfo.getAuthorityKeyIdentifierCritical())
                 out.write("CHECKED");
             }%> id="<%=CHECKBOX_AUTHORITYKEYIDENTIFIERCRITICAL%>" <%= (hasEditRights ? "" : "disabled") %>>
             <label for="<%=CHECKBOX_AUTHORITYKEYIDENTIFIERCRITICAL%>"><c:out value="<%= ejbcawebbean.getText(\"EXT_CRITICAL\") %>" /></label>
      </td>
    </tr>

    <tr  id="Row<%=row++%2%>"> 
      <td width="50%"  align="right"> 
         <%= ejbcawebbean.getText("CRL_EXT_CRLNUMBER") %>
      </td>
      <td width="50%">
           <input type="checkbox" name="<%=CHECKBOX_USECRLNUMBER %>" onClick="checkusefield('<%=CHECKBOX_USECRLNUMBER %>', '<%=CHECKBOX_CRLNUMBERCRITICAL %>')" value="<%=CHECKBOX_VALUE %>" 
           <% if((editca && x509cainfo.getUseCRLNumber()) || !editca)
                 out.write("CHECKED");
              if(isexternal) out.write(" disabled "); 
           %> id="<%=CHECKBOX_USECRLNUMBER%>" <%= (hasEditRights ? "" : "disabled") %>>
           <label for="<%=CHECKBOX_USECRLNUMBER%>"><c:out value="<%= ejbcawebbean.getText(\"USE\") %>" /></label>
           &nbsp;
          <input type="checkbox" name="<%=CHECKBOX_CRLNUMBERCRITICAL %>" value="<%=CHECKBOX_VALUE %>" 
           <%
             if(editca){
               if(!x509cainfo.getUseCRLNumber() || isexternal)
                 out.write(" disabled ");  
               else
               if(x509cainfo.getCRLNumberCritical())
                 out.write("CHECKED");
             }%> id="<%=CHECKBOX_CRLNUMBERCRITICAL%>" <%= (hasEditRights ? "" : "disabled") %>>
             <label for="<%=CHECKBOX_CRLNUMBERCRITICAL%>"><c:out value="<%= ejbcawebbean.getText(\"EXT_CRITICAL\") %>" /></label>
      </td>
    </tr>

    <tr  id="Row<%=row++%2%>"> 
      <td width="50%"  align="right"> 
         <%= ejbcawebbean.getText("CRL_EXT_ISSUINGDISTPOINT") %>
        <%= ejbcawebbean.getHelpReference("/CA_Fields.html#Issuing_Distribution_Point_on_CRLs") %>
      </td>
      <td width="50%">
           <input type="checkbox" name="<%=CHECKBOX_USECRLDISTRIBUTIONPOINTONCRL %>" onClick="checkusefield('<%=CHECKBOX_USECRLDISTRIBUTIONPOINTONCRL %>', '<%=CHECKBOX_CRLDISTRIBUTIONPOINTONCRLCRITICAL %>')" value="<%=CHECKBOX_VALUE %>" 
           <% if (editca && x509cainfo.getUseCrlDistributionPointOnCrl()) {
                 out.write("CHECKED");
              }
              if(isexternal) out.write(" disabled "); 
           %> id="<%=CHECKBOX_USECRLDISTRIBUTIONPOINTONCRL%>" <%= (hasEditRights ? "" : "disabled") %>>
           <label for="<%=CHECKBOX_USECRLDISTRIBUTIONPOINTONCRL%>"><c:out value="<%= ejbcawebbean.getText(\"USE\") %>" /></label>
           &nbsp;
          <input type="checkbox" name="<%=CHECKBOX_CRLDISTRIBUTIONPOINTONCRLCRITICAL %>" value="<%=CHECKBOX_VALUE %>" 
           <%
             if(editca){
               if(!x509cainfo.getUseCrlDistributionPointOnCrl() || isexternal)
                 out.write(" disabled ");  
               else
               if(x509cainfo.getCrlDistributionPointOnCrlCritical())
                 out.write("CHECKED");
             }%> id="<%=CHECKBOX_CRLDISTRIBUTIONPOINTONCRLCRITICAL%>" <%= (hasEditRights ? "" : "disabled") %>>
             <label for="<%=CHECKBOX_CRLDISTRIBUTIONPOINTONCRLCRITICAL%>"><c:out value="<%= ejbcawebbean.getText(\"EXT_CRITICAL\") %>" /></label>
      </td>
    </tr>

    <tr id="Row<%=row++%2%>"> 
      <td width="50%"  align="right"> 
        <%= ejbcawebbean.getText("CRL_EXT_CAISSUERS_URI") %>
        <%= ejbcawebbean.getHelpReference("/CA_Fields.html#CRL_CA_Issuer_URI") %>
      </td>
      <td width="50%">
      	<% String authorityInformationAccess = "";
       	   if(x509cainfo != null) {
    	   		final List<String> uris = x509cainfo.getAuthorityInformationAccess();
    	   		authorityInformationAccess = null != uris ? StringUtils.join(uris, ";") : "";
       		} %>
        <% if (isexternal) {%>
                <c:out value="<%= authorityInformationAccess %>"/>
        <% } else { %>
                <input type="text" name="<%=TEXTFIELD_AUTHORITYINFORMATIONACCESS%>" size="40" maxlength="256" title="<%= ejbcawebbean.getText("FORMAT_URI") %>" value="<c:out value="<%= authorityInformationAccess %>"/>" 
        	<% if (editca) { %>
        		<%= (hasEditRights ? "" : "disabled") %> />
        	<% } %> 
        <% } %>
           
      </td>
    </tr>

    <tr id="Row<%=row++%2%>"> 
      <td width="50%"  align="right"> 
         <%= ejbcawebbean.getText("KEEPEXPIREDONCRL") %> <%= ejbcawebbean.getHelpReference("/CA_Fields.html#Keep_Expired_Certificates_on_CRL") %>
      </td>
      <td width="50%">
           <input type="checkbox" name="<%=CHECKBOX_KEEPEXPIREDONCRL %>" value="<%=CHECKBOX_VALUE %>" 
           <% if (editca && x509cainfo.getKeepExpiredCertsOnCRL()) {
                 out.write("CHECKED");
              }
              if(isexternal) out.write(" disabled "); 
           %> id="<%=CHECKBOX_KEEPEXPIREDONCRL%>">
           <label for="<%=CHECKBOX_KEEPEXPIREDONCRL%>"><c:out value="<%= ejbcawebbean.getText(\"USE\") %>" /></label>
      </td>
    </tr>

   <tr id="Row<%=row%2%>"> 
     <td width="50%"  align="right"> 
       <strong><%= ejbcawebbean.getText("CRL_CA_CRLPERIOD") %></strong> <%= ejbcawebbean.getText("FORMAT_TIME_YMDHMIN") %> <%= ejbcawebbean.getHelpReference("/CA_Fields.html#CRL_Period") %>
     </td>
     <td width="50%">
          <% if (isexternal) {
               out.write(SimpleTime.getInstance(cainfo.getCRLPeriod()).toString(SimpleTime.TYPE_MINUTES));
             } else { %>
        <input type="obligatory" name="<%=TEXTFIELD_CRLPERIOD%>" id="<%=TEXTFIELD_CRLPERIOD%>" size="20" maxlength="255" title="<%= ejbcawebbean.getText("FORMAT_TIME_YMDHMIN") %>"
          <%   if (editca) { out.write(" value='" + SimpleTime.getInstance(cainfo.getCRLPeriod()).toString(SimpleTime.TYPE_MINUTES) + "'"); }
               else { out.write(" value='1"+SimpleTime.TYPE_DAYS+"'"); } %> <%= (hasEditRights ? "" : "disabled") %>>
          <% } %>
          &nbsp; <%= ejbcawebbean.getText("YEAR365DAYS") + ", " + ejbcawebbean.getText("MO30DAYS") %> 
     </td>
   </tr>

   <tr id="Row<%=row%2%>"> 
     <td width="50%"  align="right"> 
       <%= ejbcawebbean.getText("CRL_CA_ISSUEINTERVAL") %> <%= ejbcawebbean.getText("FORMAT_TIME_YMDHMIN") %> <%= ejbcawebbean.getHelpReference("/CA_Fields.html#CRL_Period") %>
     </td>
     <td width="50%">
          <% if (isexternal) {
               out.write(SimpleTime.getInstance(cainfo.getCRLIssueInterval()).toString(SimpleTime.TYPE_MINUTES));
             } else { %>
        <input type="text" name="<%=TEXTFIELD_CRLISSUEINTERVAL%>" size="20" maxlength="255" title="<%= ejbcawebbean.getText("FORMAT_TIME_YMDHMIN") %>"
          <%   if (editca) { out.write(" value='" + SimpleTime.getInstance(cainfo.getCRLIssueInterval()).toString(SimpleTime.TYPE_MINUTES) + "'"); }
               else { out.write(" value='0"+SimpleTime.TYPE_MINUTES+"'"); } %> <%= (hasEditRights ? "" : "disabled") %>>
          <% } %> 
          &nbsp; <%= ejbcawebbean.getText("YEAR365DAYS") + ", " + ejbcawebbean.getText("MO30DAYS") %> 
     </td>
   </tr>

   <tr id="Row<%=row%2%>"> 
     <td width="50%"  align="right"> 
       <%= ejbcawebbean.getText("CRL_CA_OVERLAPTIME") %> <%= ejbcawebbean.getText("FORMAT_TIME_YMDHMIN") %> <%= ejbcawebbean.getHelpReference("/CA_Fields.html#CRL_Period") %>
     </td>
     <td width="50%">
          <% if (isexternal) {
               out.write(SimpleTime.getInstance(cainfo.getCRLOverlapTime()).toString(SimpleTime.TYPE_MINUTES));
             } else { %>
        <input type="text" name="<%=TEXTFIELD_CRLOVERLAPTIME%>" size="20" maxlength="255" title="<%= ejbcawebbean.getText("FORMAT_TIME_YMDHMIN") %>"
          <%   if (editca) { out.write(" value='" + SimpleTime.getInstance(cainfo.getCRLOverlapTime()).toString(SimpleTime.TYPE_MINUTES) + "'"); }
               else {out.write(" value='10"+SimpleTime.TYPE_MINUTES+"'"); } %> <%= (hasEditRights ? "" : "disabled") %>>
          <% } %> 
          &nbsp; <%= ejbcawebbean.getText("YEAR365DAYS") + ", " + ejbcawebbean.getText("MO30DAYS") %> 
     </td>
   </tr>

   <tr id="Row<%=row++%2%>"> 
     <td width="50%"  align="right"> 
       <%= ejbcawebbean.getText("CRL_CA_DELTACRLPERIOD") %> <%= ejbcawebbean.getText("FORMAT_TIME_YMDHMIN") %> <%= ejbcawebbean.getHelpReference("/CA_Fields.html#CRL_Period") %>
     </td>
     <td width="50%">
          <% if (isexternal) {
               out.write("" + SimpleTime.getInstance(cainfo.getDeltaCRLPeriod()).toString(SimpleTime.TYPE_MINUTES));
             } else { %>
        <input type="obligatory" name="<%=TEXTFIELD_DELTACRLPERIOD%>" id="<%=TEXTFIELD_DELTACRLPERIOD%>" size="20" maxlength="255" title="<%= ejbcawebbean.getText("FORMAT_TIME_YMDHMIN") %>"
          <%   if (editca) { out.write(" value='" + SimpleTime.getInstance(cainfo.getDeltaCRLPeriod()).toString(SimpleTime.TYPE_MINUTES) + "'"); }
               else { out.write(" value='0"+SimpleTime.TYPE_MINUTES+"'");} %> <%= (hasEditRights ? "" : "disabled") %> />
          <% } %> 
          &nbsp; <%= ejbcawebbean.getText("YEAR365DAYS") + ", " + ejbcawebbean.getText("MO30DAYS") %>
          <p class="help"><c:out value="<%= ejbcawebbean.getText(\"CRL_CA_DELTACRLPERIOD_HELP\") %>" /></p>
     </td>
   </tr>

   <tr  id="Row<%=row++%2%>"> 
     <td width="50%" align="right"> 
       <%= ejbcawebbean.getText("PUBLISHERS") %> <br />&nbsp;
     </td>
     <td width="50%"> 
       <select class="select-list" name="<%=SELECT_AVAILABLECRLPUBLISHERS%>" size="5" multiple <%= (hasEditRights ? "" : "disabled") %> >
          <%   Collection usedpublishers = null;
               if(editca) usedpublishers = cainfo.getCRLPublishers(); 
               Iterator iter = publisheridtonamemap.keySet().iterator(); 
               while(iter.hasNext()){
                 Integer next = (Integer) iter.next(); %>
          <option  value="<%= next %>" 
             <%    if(editca && usedpublishers.contains(next))
                     out.write(" selected ");
                 %>>
             <c:out value="<%= publisheridtonamemap.get(next) %>"/>                 
          </option>  
             <% } %>
       </select>
     </td>
   </tr>
    <% } // if (!isexternal) %>

    <%-- ---------- Default CA defined validation data --- --%>

    <% if (!isexternal) { %>

    <tr id="Row<%=row%2%>" class="section"> 
      <td width="50%"  align="right"> 
        <strong><%= ejbcawebbean.getText("DEFAULT_VALIDATION_DATA") %></strong>
      </td>
      <td width="50%"> 
        <small><%= ejbcawebbean.getText("DEFAULT_VALIDATION_DATA_HELP") %></small>
      </td>
    </tr>

    <tr  id="Row<%=row%2%>"> 
      <td width="50%"  align="right"> 
        <strong><%= ejbcawebbean.getText("EXT_PKIX_CDP_DEFAULTURI") %></strong>
        <%= ejbcawebbean.getHelpReference("/Certificate_Profile_Fields.html#CRL_Distribution_Points") %>
      </td>
      <td width="50%">
           <% if(isexternal){%>
                <c:out value="<%= x509cainfo.getDefaultCRLDistPoint() %>"/>
              <%}else{ %>
         <input type="text" name="<%=TEXTFIELD_DEFAULTCRLDISTPOINT%>" size="40" maxlength="4096" title="<%= ejbcawebbean.getText("FORMAT_URI") %>"
         <% if(editca){%>value="<c:out value="<%= x509cainfo.getDefaultCRLDistPoint() %>"/>"<%}%>  <%= (hasEditRights ? "" : "disabled") %> />
         <% } %> 
           <input type="button" name="<%=BUTTON_GENDEFAULTCRLDISTPOINT%>" onClick="gendefaultcrldistpoint()" value="<%= ejbcawebbean.getText("GENERATE") %>" 
           	<%= (hasEditRights ? "" : "disabled") %> />
		   <p class="help"><c:out value="<%= ejbcawebbean.getText(\"CRL_CA_DEFAULTVALUES_HELP\") %>" /></p>
      </td>
    </tr>

    <tr  id="Row<%=row%2%>"> 
      <td width="50%"  align="right"> 
        <%= ejbcawebbean.getText("EXT_PKIX_CDP_DEFAULTCRLISSUER") %>
        <%= ejbcawebbean.getHelpReference("/Certificate_Profile_Fields.html#CRL_Issuer") %>
      </td>
      <td width="50%">
           <% if(isexternal){%>
                <c:out value="<%= x509cainfo.getDefaultCRLIssuer() %>"/>
             <% }else{ %>
         <input type="text" name="<%=TEXTFIELD_DEFAULTCRLISSUER%>" size="40" maxlength="255" title="<%= ejbcawebbean.getText("FORMAT_DN") %>"
         <% if(editca){%>value="<c:out value="<%= x509cainfo.getDefaultCRLIssuer() %>"/>"<%}%> <%= (hasEditRights ? "" : "disabled") %> >
           <% } %> 
           <input type="button" name="<%=BUTTON_GENDEFAULTCRLISSUER%>" onClick="gendefaultcrlissuer()" value="<%= ejbcawebbean.getText("GENERATE") %>" 
           	<%= (hasEditRights ? "" : "disabled") %>/>
		   <p class="help"><c:out value="<%= ejbcawebbean.getText(\"CRL_CA_DEFAULTVALUES_HELP\") %>" /></p>
      </td>
    </tr>

    <tr  id="Row<%=row++%2%>"> 
      <td width="50%"  align="right"> 
        <%= ejbcawebbean.getText("EXT_PKIX_FCRL_DEFAULTURI") %>
        <%= ejbcawebbean.getHelpReference("/Certificate_Profile_Fields.html#Freshest_CRL") %>
      </td>
      <td width="50%">
           <% if(isexternal){%>
                <c:out value="<%= x509cainfo.getCADefinedFreshestCRL() %>"/>
              <%}else{ %>
         <input type="text" name="<%=TEXTFIELD_CADEFINEDFRESHESTCRL%>" size="40" maxlength="255" title="<%= ejbcawebbean.getText("FORMAT_URI") %>"
         <% if(editca && (x509cainfo.getCADefinedFreshestCRL() != null)){%>value="<c:out value="<%= x509cainfo.getCADefinedFreshestCRL() %>"/>"<%}%> 
         	<%= (hasEditRights ? "" : "disabled") %>/>
           <% } %>
           <input type="button" name="<%=BUTTON_GENCADEFINEDFRESHESTCRL%>" onClick="gencadefinedfresherstcrl()" value="<%= ejbcawebbean.getText("GENERATE") %>" 
           	<%= (hasEditRights ? "" : "disabled") %>/>
		   <p class="help"><c:out value="<%= ejbcawebbean.getText(\"CRL_CA_DEFAULTVALUES_HELP\") %>" /></p>
      </td>
    </tr>

     <tr  id="Row<%=row++%2%>"> 
      <td width="50%"  align="right"> 
        <strong><%= ejbcawebbean.getText("EXT_PKIX_AIA_OCSP_DEFAULTURI") %></strong>
        <%= ejbcawebbean.getHelpReference("/CA_Fields.html#Default_CA_Defined_Validation_Data") %>
      </td>
      <td width="50%">
           <% if(isexternal){%>
                <c:out value="<%= x509cainfo.getDefaultOCSPServiceLocator() %>"/>
             <% }else{ %>
         <input type="text" name="<%=TEXTFIELD_DEFAULTOCSPLOCATOR%>" size="40" maxlength="255" title="<%= ejbcawebbean.getText("FORMAT_URI") %>"
         <% if(editca){ %>value="<c:out value="<%= x509cainfo.getDefaultOCSPServiceLocator() %>"/>"<%}%> <%= (hasEditRights ? "" : "disabled") %> />
           <% } %> <input type="button" name="<%=BUTTON_GENDEFAULTOCSPLOCATOR%>" onClick="gendefaultocsplocator()" 
           	value="<%= ejbcawebbean.getText("GENERATE") %>" <%= (hasEditRights ? "" : "disabled") %> />
      </td>
    </tr>

    <tr  id="Row<%=row++%2%>">
      <td width="50%"  align="right"> 
        <%= ejbcawebbean.getText("EXT_PKIX_AIA_CAISSUERS_DEFAULTURI") %>
        <%= ejbcawebbean.getHelpReference("/CA_Fields.html#Default_CA_Defined_Validation_Data") %>
      </td>
        <% String certificateAiaDefaultCaIssuerUri = "";
       	   if(x509cainfo != null) {
    	   		final List<String> uris = x509cainfo.getCertificateAiaDefaultCaIssuerUri();
    	   		certificateAiaDefaultCaIssuerUri = null != uris ? StringUtils.join( uris, ";") : "";
       		} %>
      <td width="50%">
           <% if (isexternal) {%>
                <c:out value="<%= certificateAiaDefaultCaIssuerUri %>"/>
           <% } else { %>
                <input type="text" name="<%=TEXTFIELD_CERTIFICATEAIADEFAULTCAISSUERURI%>" size="40" maxlength="255" title="<%= ejbcawebbean.getText("FORMAT_URI") %>"
           		<% if (editca) { %>
           			value="<c:out value="<%= certificateAiaDefaultCaIssuerUri %>"/>"
           		<% } %> 
           		<%= (hasEditRights ? "" : "disabled") %> />
           <% } %>
      </td>
    </tr>

    <% } // if (!isexternal) %>

    <% } // if (catype == CAInfo.CATYPE_X509) %>

    <% if (!isexternal) { %>
    <!-- This last part with Approvals and Other data (Validators, FinishUser, etc.) is not used for external CAs. -->

	<%-- ---------- Approvals -------------------- --%>

    <tr id="Row<%=row%2%>" class="section">
        <td width="50%" align="right">
        <strong><%= ejbcawebbean.getText("APPROVALSETTINGS") %></strong>
        </td>
        <td width="50%">&nbsp;</td>
    </tr>

    <% for (ApprovalRequestType approvalRequestType : ApprovalRequestType.values()) { %>
    <tr id="Row<%=row%2%>"> 
    	<td width="50%"  align="right"> <c:out value="<%= ejbcawebbean.getText(approvalRequestType.getLanguageString()) %>"/></td>
    	<td width="50%">
    		<select name="<%=SELECT_APPROVALPROFILE + "_" + approvalRequestType.getIntegerValue()%>" size="1" <%= (hasEditRights ? "" : "disabled") %> >
         	 <%      		   
               List<Integer> approvalProfileIds = ejbcawebbean.getSortedApprovalProfileIds();
               for(Integer approvalProfile : approvalProfileIds) { %>
        	 	<option  value="<%= approvalProfile %>" 
                <% if(editca) {
                       Integer usedapprovalprofile = cainfo.getApprovals().get(approvalRequestType);
                       if(approvalProfile.equals(usedapprovalprofile)) {
                      		out.write(" selected ");
                	   }
                	}
                 %>>
             <c:out value="<%= approvalProfileMap.get(approvalProfile) %>"/>                 
          </option>  
             <% } %>
       </select>
    	</td>
    </tr>
    <% } %>

    <%-- ---------- Other data -------------------- --%>

    <tr id="Row<%=row%2%>" class="section">
        <td width="50%" align="right">
        <strong><%= ejbcawebbean.getText("OTHERDATA") %></strong>
        </td>
        <td width="50%">&nbsp;</td>
    </tr>

   <tr  id="Row<%=row++%2%>"> 
     <td width="50%" align="right"> 
       <%= ejbcawebbean.getText("VALIDATORS") %> <%= ejbcawebbean.getHelpReference("/Validators.html") %>
     </td>
     <td width="50%"> 
       <select class="select-list" name="<%= SELECT_AVAILABLEVALIDATORS %>" size="5" multiple <%= (hasEditRights ? "" : "disabled") %> style="min-width: 10em" >
          <% Collection usedKeyValidators = null;
               if(editca) {
                   usedKeyValidators = cainfo.getValidators(); 
               }
               for(Integer validatorId : keyValidatorMap.keySet()) {
            	   String validatorName = keyValidatorMap.get(validatorId);  %>
          <option  value="<%= validatorId %>" 
             <%    if(editca && usedKeyValidators.contains(validatorId))
                     out.write(" selected ");
                 %>>
             <c:out value="<%= validatorName %>"/>                 
          </option>  
             <% } %>
       </select>
     </td>
   </tr>    

    <% if (catype == CAInfo.CATYPE_X509) { %>
    <% if (!editca || (editca && cmscainfo != null)) { %>
    <tr id="Row<%=row++%2%>"> 
      <td width="50%"  align="right"> 
        <%= ejbcawebbean.getText("CMSSERVICE") %>
      </td>
      <td width="50%">
		<table border="0" cellspacing="0" cellpadding="0">
			<tr>
				<td style='padding-right: 1.5em !important;'><input type="checkbox" name="<%=CHECKBOX_ACTIVATECMSSERVICE %>" value="<%=CHECKBOX_VALUE %>"
					<% if(waitingresponse || (editca && !isUninitialized && cmscainfo == null)) out.write(" disabled ");%>
					<% if((editca && (cmscainfo.getStatus() == ExtendedCAServiceInfo.STATUS_ACTIVE)))
						out.write("CHECKED");%> id="<%=CHECKBOX_ACTIVATECMSSERVICE%>" <%= (hasEditRights ? "" : "disabled") %>>
					<label for="<%=CHECKBOX_ACTIVATECMSSERVICE%>"><c:out value='<%= ejbcawebbean.getText("ACTIVATE") %>' /></label></td>
				<td style='padding-bottom: .5em !important;'>
					<% if(editca && !isUninitialized){ %>
					<input type="submit" name="<%= BUTTON_REVOKERENEWCMSCERTIFICATE %>" <% if(waitingresponse) out.write(" disabled ");%>
						value='<%= ejbcawebbean.getText("REVOKERENEWCMSCERT") %>'
						<%= (hasEditRights ? "" : "disabled") %>>
					<% } %>
					&nbsp;
					</td>
			</tr>
		<% if(editca && !isUninitialized){ %>
			<% if(cmscert != null){ %>
			<tr>
				<td>&nbsp;</td>
				<td><button type='button' onclick='viewcmscert()' title='<%= ejbcawebbean.getText("VIEW_CMSCERTIFICATE_TITLE") %> <%= ejbcawebbean.getText("POPUP_WINDOW") %>'><c:out value='<%= ejbcawebbean.getText("VIEW_CMSCERTIFICATE") %>' /></button></td>
			</tr>
			<% } %>
		<% } %>
		</table>
      </td>
    </tr>    
    <% } %>
    <% } // if (catype == CAInfo.CATYPE_X509) %>

    <tr id="Row<%=row++%2%>"> 
        <td width="50%"  align="right"> 
            <%= ejbcawebbean.getText("FINISHUSER") %> <%= ejbcawebbean.getHelpReference("/CA_Fields.html#Finish_User") %>
        </td>
        <td width="50%"> 
            <input type="checkbox" name="<%=CHECKBOX_FINISHUSER %>" value="<%=CHECKBOX_VALUE %>" 
                <% if ((editca && cainfo.getFinishUser()) || !editca) { 
                out.write("CHECKED"); } %> id="<%=CHECKBOX_FINISHUSER%>" <%= (hasEditRights ? "" : "disabled") %>>
                <label for="<%=CHECKBOX_FINISHUSER%>"><c:out value="<%= ejbcawebbean.getText(\"USE\") %>" /></label>         
        </td>
    </tr>

    <% if (catype == CAInfo.CATYPE_X509) { %>
    <tr id="Row<%=row++%2%>"> 
      <td width="50%"  align="right"> 
        <%= ejbcawebbean.getText("SHAREDCMPRASECRET") %> <%= ejbcawebbean.getHelpReference("/CA_Fields.html#CMP_RA_Authentication_Secret") %>
      </td>
      <td width="50%">
        <% String cmpRaAuthSecretValue = (editca?((X509CAInfo)cainfo).getCmpRaAuthSecret():""); %>
        <input type="password" autocomplete="off" name="<%=TEXTFIELD_SHAREDCMPRASECRET%>" size="20" maxlength="64" value="<c:out value="<%= cmpRaAuthSecretValue %>"/>"
        	<%= (hasEditRights ? "" : "disabled") %>>
      </td>
    </tr>
    <% } %>

    <tr id="Row<%=row++%2%>"> 
        <td width="50%"  align="right"> 
            <%= ejbcawebbean.getText("INCLUDEINHEALTHCHECK") %> <%= ejbcawebbean.getHelpReference("/Monitoring_and_Healthcheck.html") %>
        </td>
        <td width="50%">
            <input type="checkbox" name="<%=CHECKBOX_INCLUDEINHEALTHCHECK%>" value="<%=CHECKBOX_VALUE%>" id="<%=CHECKBOX_INCLUDEINHEALTHCHECK%>"
                <% if (cainfo!=null && cainfo.getIncludeInHealthCheck()) { out.write("CHECKED"); } %>
                <%= (hasEditRights ? "" : "disabled") %> >
                <label for="<%=CHECKBOX_INCLUDEINHEALTHCHECK%>"><c:out value="<%= ejbcawebbean.getText(\"ACTIVATE\") %>" /></label>
        </td>
    </tr>

    <% } // if (!isexternal) %>


    <%-- ---------- Form buttons -------------------- --%>

    <tr id="Row<%=row++%2%>"><td width="50%" align="right">&nbsp;</td><td width="50%">&nbsp;</td></tr>
    <tr id="Row<%=row++%2%>"> 
        <td width="49%" valign="top" align="right"></td>
        <td width="51%" valign="top">
        <% if (!isexternal) {
            if (editca && !isUninitialized && hasEditRights) { %>
                <input type="submit" name="<%= BUTTON_SAVE %>"  onClick='return checkallfields()' value="<%= ejbcawebbean.getText("SAVE") %>">
        <%  } else if (editca && isUninitialized && hasEditRights) {
                if (cryptoTokenIdParam != null) { %>
                    <input type="submit" name="<%= BUTTON_SAVE %>"  onClick='return checkallfields()' value="<%= ejbcawebbean.getText("SAVE") %>">
                    <input type="submit" name="<%= BUTTON_INITIALIZE %>"  onClick='return checkallfields()' value="<%= ejbcawebbean.getText("SAVE_AND_INITIALIZE") %>"> 
                <% } else if (isUninitialized) { %>
                    <p><strong><%= ejbcawebbean.getText("CRYPTOTOKEN_DOESNT_EXIST_CANT_INITIALIZE") %></strong></p>
                    <input type="submit" name="<%= BUTTON_SAVE %>"  onClick='return checkallfields()' value="<%= ejbcawebbean.getText("SAVE") %>">
                <% } else { %>
                    <p><strong><%= ejbcawebbean.getText("CRYPTOTOKEN_DOESNT_EXIST_CANT_SAVE") %></strong></p> 
                <% } %>
        <%  } else if (hasCreateRights){ %>
                <input type="submit" name="<%= BUTTON_CREATE %>" onClick='return checkallfields()' value="<%= ejbcawebbean.getText("CREATE") %>">
        <%  } %>     
            &nbsp;&nbsp;&nbsp;
            <input type="submit" name="<%= BUTTON_CANCEL %>" value="<%= ejbcawebbean.getText("CANCEL") %>">
        <% } else { %>
        <%  if (catype==CAInfo.CATYPE_X509 && hasEditRights) {  %>
            <input type="submit" name="<%= BUTTON_SAVE_EXTERNALCA %>"  value="<%= ejbcawebbean.getText("SAVE") %>">
            &nbsp;&nbsp;&nbsp;
            <input type="submit" name="<%= BUTTON_CANCEL %>" value="<%= ejbcawebbean.getText("CANCEL") %>">
        <%  } else { %>
            <input type="submit" name="<%= BUTTON_CANCEL %>" value="<%= ejbcawebbean.getText("BACK") %>">
        <%  } %>
        <% } %>
        </td>
    </tr>

    <%-- ---------- Other CA actions -------------------- --%>

    <% if (editca && revokable && hasEditRights) { %>
    <tr id="Row<%=row++%2%>"><td width="50%" align="right">&nbsp;</td><td width="50%">&nbsp;</td></tr>
    <tr id="Row<%=row++%2%>" class="section">
        <td width="50%" align="right">
        <strong><%= ejbcawebbean.getText("CALIFECYCLE") %></strong>
        </td>
        <td width="50%">&nbsp;</td>
    </tr>
    <tr id="Row<%=row++%2%>"> 
        <td width="49%" valign="top">&nbsp;</td>
        <td width="51%" valign="top">         
            <select name="<%=SELECT_REVOKEREASONS %>" >
            <% for (int i=0; i < SecConst.reasontexts.length; i++) {
                   if (i!= 7) { %>
                       <option value='<%= i%>'><%= ejbcawebbean.getText(SecConst.reasontexts[i]) %></option>
            <%     } 
               } %>
            </select>
            <input type="submit" name="<%= BUTTON_REVOKECA %>" value="<%= ejbcawebbean.getText("REVOKE") %>" onClick='return confirmrevocation()'>     
        </td>
    </tr>
    <% } %>   

    <%
        final int cryptoTokenId = catoken==null ? currentCryptoTokenId : catoken.getCryptoTokenId();
        // Cache the lookup/iteration over all the keys in the CryptoToken
        List<String> availableCryptoTokenAliases = null;
        if (!isexternal && cabean.isCryptoTokenPresent(cryptoTokenId) && cabean.isCryptoTokenActive(cryptoTokenId)) {
            availableCryptoTokenAliases = cabean.getAvailableCryptoTokenAliases(cryptoTokenId, signatureAlgorithmParam);
        }
        if (editca && !isexternal && !waitingresponse && cabean.isCryptoTokenPresent(cryptoTokenId) && cabean.isCryptoTokenActive(cryptoTokenId) && cainfo.getSignedBy()!=CAInfo.SIGNEDBYEXTERNALCA && !isRevoked) { %>
    <tr id="Row<%=row++%2%>"><td width="50%" align="right">&nbsp;</td><td width="50%">&nbsp;</td></tr>
    <tr id="Row<%=row++%2%>"> 
        <td width="49%" valign="top" align="right"><%= ejbcawebbean.getText("RENEWCA") %> <%= ejbcawebbean.getHelpReference("/Renewing_a_SubCA_Signed_by_an_External_CA.html") %></td>
        <td width="51%" valign="top">
            <table>
                <tbody>
                    <tr>
                        <td><%= ejbcawebbean.getText("RENEWCA_NEXTCAKEY") %></td>
                        <td>
                            <select name="<%= SELECT_CRYPTOTOKEN_CERTSIGNKEY_RENEW %>" size="1" <%= (hasEditRights ? "" : "disabled") %>>
                                <option value="" ><c:out value="<%= ejbcawebbean.getText(\"RENEWCA_USINGKEYSEQUENCE\") %>"/></option>
                            <%  for (final String alias : availableCryptoTokenAliases) {
                                final boolean selected = alias.equals(catoken.getAliasFromPurpose(CATokenConstants.CAKEYPURPOSE_CERTSIGN));
                                final String entrySelected = selected ? "selected" : "";
                            %>
                                <option value='<c:out value="<%=alias %>"/>' <%=entrySelected %>><c:out value="<%= alias %>"/></option>
                            <%  } %>
                            </select>
                        </td>
                    </tr>
                    <% if (catype==CAInfo.CATYPE_X509 && cainfo.getSignedBy() == CAInfo.SELFSIGNED && globalconfiguration.getEnableIcaoCANameChange()) { 
                        		String newCAName = cainfo.getSubjectDN();%>
                        <tr id="Row<%=row%2%>"> 
					        <td width="50%" align="left"> 
					            <%= ejbcawebbean.getText("RENEWCA_USECANAMECHANGE") %> <%= ejbcawebbean.getHelpReference("/CA_Fields.html#CA_Name_Change") %>
					        </td>
					        <td width="50%"> 
					            <input id="<%=ID_CHECKBOX_CANAMECHANGE%>" type="checkbox" name="<%=CHECKBOX_CANAMECHANGE %>" value="<%=CHECKBOX_VALUE %>" onchange="toggleCANameChange()" <%= (hasEditRights ? "" : "disabled") %> />
					        </td>
					    </tr>
	                    <tr id="Row<%=row++%2%>">
	                        <td align="left" ><%= ejbcawebbean.getText("RENEWCA_NEW_SUBJECT_DN_ICAO") %></td>
	                        <td>
	                            <input type="text" id="<%=ID_NEWSUBJECTDN%>" name="<%= TEXTFIELD_NEWSUBJECTDN %>" value="<%=newCAName%>" size="45" maxlength="225" title="<%= ejbcawebbean.getText("FORMAT_DN") %>" disabled />
	                        </td>
	                    </tr>
                    <%  } %>
                    <tr id="Row<%=row++%2%>">
                        <td><%= ejbcawebbean.getText("RENEWCA_LINKCERTIFICATE") %></td>
                        <td>
                        <% if (catype==CAInfo.CATYPE_CVC) { %>
                            <input type="checkbox" name="<%= CHECKBOX_CREATELINKCERTIFICATE %>" value="<%=CHECKBOX_VALUE%>" checked disabled/>
                        <% } else { %>
                            <input type="checkbox" name="<%= CHECKBOX_CREATELINKCERTIFICATE %>" value="<%=CHECKBOX_VALUE%>" <%= (hasEditRights ? "" : "disabled") %>/>
                        <% } %>
                        </td>
                    </tr>
                    <tr id="Row<%=row++%2%>">
                        <td></td>
                        <td>
                            <input type="submit" name="<%= BUTTON_RENEWCA %>" onClick='return confirmrenewal()' value="<%= ejbcawebbean.getText("RENEWCA") %>" <%= (hasEditRights ? "" : "disabled") %> />
                        </td>
                    </tr>
                    <tr id="Row<%=row++%2%>">
                        <td><%= ejbcawebbean.getText("RENEWCA_FROMLASTRENEWAL") %></td>
                        <td>
                        <% if (cabean.getLinkCertificate(caid)!=null) { %>
                            <a href="adminweb/ca/editcas/cacertreq?cmd=linkcert&format=binary&caid=<%=caid%>">DER</a>,
                            <a href="adminweb/ca/editcas/cacertreq?cmd=linkcert&caid=<%=caid%>">PEM</a>
                        <% } else { %>
                            <span><%= ejbcawebbean.getText("RENEWCA_NOTAVAILABLE") %></span>
                        <% } %>
                        </td>
                    </tr>
                </tbody>
            </table>
        </td>
    </tr>
    <% } %>
    
    <%
    if (editca) {
	    Date rolloverDate = cabean.getRolloverNotBefore(caid);
	    if (rolloverDate != null) {
	    	Date now = new Date();
	    	Date currentValidity = cabean.getRolloverNotAfter(caid); %>
    <tr id="Row<%=row++%2%>"><td width="50%" align="right">&nbsp;</td><td width="50%">&nbsp;</td></tr>
    <tr id="Row<%=row++%2%>"> 
        <td width="49%" valign="top" align="right"><%= ejbcawebbean.getText("CAROLLOVER") %></td>
        <td width="51%" valign="top">
            <%= ejbcawebbean.getText("CAROLLOVERNOTAFTER") %>: <%= ejbcawebbean.formatAsISO8601(currentValidity) %><br />
	        <%= ejbcawebbean.getText("CAROLLOVERNOTBEFORE") %>: <%= ejbcawebbean.formatAsISO8601(rolloverDate) %><br />
            <input type="submit" name="<%= BUTTON_ROLLOVER %>" value="<%= ejbcawebbean.getText("CAROLLOVERBUTTON") %>"
            	<%= rolloverDate.after(now) ? " onclick=\"return confirm('Next certificate is not yet valid! Are you sure?')\"" : ""  %>
            >
        </td>
    </tr>
      <% } 
    } %> 

    <% if (editca && !isexternal && !waitingresponse && hasEditRights) { %>
    <tr id="Row<%=row++%2%>"><td width="50%" align="right">&nbsp;</td><td width="50%">&nbsp;</td></tr>
    <tr id="Row<%=row++%2%>"> 
        <td width="49%" valign="top" align="right"></td>
        <td width="51%" valign="top">
            <input type="submit" name="<%= BUTTON_PUBLISHCA %>" value="<%= ejbcawebbean.getText("REPUBLISHCA") %>" >
        </td>
    </tr>
    <% } %> 

    <% if (!isexternal && cabean.isCryptoTokenPresent(cryptoTokenId) && cabean.isCryptoTokenActive(cryptoTokenId) && hasEditRights) { %>
    <tr id="Row<%=row++%2%>" class="section">
        <td width="50%" align="right">
        <strong><%= ejbcawebbean.getText("EXTERNALLYSIGNED_CA_CREATERENEW") %></strong>
        </td>
        <td width="50%">&nbsp;</td>
    </tr>
    <tr id="Row<%=row++%2%>">
        <td width="49%" valign="top">&nbsp;</td>
        <td width="51%" valign="top">
            <table>
                <tbody>
                    <%  if (editca) { %>
                    <tr><td colspan="2"><strong><%= ejbcawebbean.getText("EXTERNALLYSIGNED_STEP1") %></strong></td></tr>
                    <tr>
                        <td><%= ejbcawebbean.getText("EXTERNALLYSIGNED_NEXTKEY") %></td>
                        <td>
                            <select name="<%= SELECT_CRYPTOTOKEN_CERTSIGNKEY_MAKEREQUEST %>" size="1">
                                <option value="" ><c:out value="<%= ejbcawebbean.getText(\"RENEWCA_USINGKEYSEQUENCE\") %>"/></option>
                        <%  for (final String alias : availableCryptoTokenAliases) {
                                final boolean selected = alias.equals(catoken.getAliasFromPurpose(CATokenConstants.CAKEYPURPOSE_CERTSIGN));
                                final String entrySelected = selected ? "selected" : "";
                        %>
                                <option value='<c:out value="<%=alias %>"/>' <%=entrySelected %>><c:out value="<%= alias %>"/></option>
                        <%  } %>
                            </select>
                        </td>
                    </tr>

                    <%  } %>
                    <tr>
                        <td><%= ejbcawebbean.getText("EXTERNALLYSIGNED_CACHAIN") %><br/>
                            <p class="help"><%= ejbcawebbean.getText("EXTERNALLYSIGNED_CACHAIN_HELP") %></p></td>
                        <td>
                            <input type="file" name="<%= FILE_RECIEVEFILE_MAKEREQUEST %>">
                        </td>
                    </tr>
                    <tr>
                        <td></td>
                        <td>
                            <input type="submit" name="<%= BUTTON_MAKEREQUEST %>" onClick='return checkallfields()' value="<%= ejbcawebbean.getText("MAKEREQUEST") %>" >
                        </td>
                    </tr>
                    <%  if (editca) { %>
                    <tr><td>&nbsp;</td><td>&nbsp;</td></tr>
                    <tr><td colspan="2"><strong><%= ejbcawebbean.getText("EXTERNALLYSIGNED_STEP2") %></strong></td></tr>
                    <tr>
                        <td><%= ejbcawebbean.getText("EXTERNALLYSIGNED_CAKEY") %></td>
                        <td>
                            <select name="<%= SELECT_CRYPTOTOKEN_CERTSIGNKEY_RECEIVEREQ %>" size="1">
                        <%  for (final String alias : availableCryptoTokenAliases) {
                                final boolean selected = alias.equals(catoken.getAliasFromPurpose(CATokenConstants.CAKEYPURPOSE_CERTSIGN));
                                final String entrySelected = selected ? "selected" : "";
                                %>
                                <option value='<c:out value="<%=alias %>"/>' <%=entrySelected %>><c:out value="<%= alias %>"/></option>
                        <%  } %>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td><%= ejbcawebbean.getText("EXTERNALLYSIGNED_CACERT") %><br/>
                            <p class="help"><%= ejbcawebbean.getText("EXTERNALLYSIGNED_CACERT_HELP") %></p></td>
                        <td>
                            <input type="file" name="<%= FILE_RECIEVEFILE_RECEIVEREQUEST %>">
                        </td>
                    </tr>
                    <% if (catype == CAInfo.CATYPE_X509 && !waitingresponse) { %>
                    <tr>
                        <td><p class="help"><%= ejbcawebbean.getText("EXTERNALLYSIGNED_FUTUREROLLOVER_HELP") %></p></td>
                        <td>
                            <label>
                            	<input type="checkbox" name="<%=CHECKBOX_FUTUREROLLOVER %>" id="<%=CHECKBOX_FUTUREROLLOVER %>" value="<%=CHECKBOX_VALUE %>" />
                            	<%-- TODO: configurable default value in CAInfo? --%>
                            	<c:out value="<%= ejbcawebbean.getText(\"EXTERNALLYSIGNED_FUTUREROLLOVER\") %>" />
                            </label>
                        </td>
                    </tr>
                    <% } %>
                    <tr>
                        <td></td>
                        <td>
                            <input type="submit" name="<%= BUTTON_RECEIVEREQUEST %>" onClick='return checkallfields()' value="<%= ejbcawebbean.getText("RECIEVEREQUEST") %>" >
                        </td>
                    </tr>
                    <%  } %>
                </tbody>
            </table>
        </td>
    </tr>
    <% } %>

    <% if (isexternal && editca && hasEditRights) { %>
    <tr id="Row<%=row++%2%>" class="section">
        <td width="50%" align="right">
        <strong><%= ejbcawebbean.getText("IMPORTED_CA_RENEWAL") %></strong>
        </td>
        <td width="50%">&nbsp;</td>
    </tr>
    <tr id="Row<%=row++%2%>">
        <td width="49%" valign="top">&nbsp;</td>
        <td width="51%" valign="top">
            <table>
                <tbody>
                    <tr>
                        <td><%= ejbcawebbean.getText("IMPORTED_CA_RENEWAL_NEWCERT") %><br/>
                            <p class="help"><%= ejbcawebbean.getText("IMPORTED_CA_RENEWAL_NEWCERT_HELP") %></p></td>
                        <td>
                            <input type="file" name="<%= FILE_RECIEVEFILE_IMPORTED_RENEWAL %>">
                        </td>
                    </tr>
                    <tr>
                        <td></td>
                        <td>
                            <input type="submit" name="<%= BUTTON_RECEIVE_IMPORT_RENEWAL %>" value="<%= ejbcawebbean.getText("RECEIVE_IMPORT_RENEWAL") %>" >
                        </td>
                    </tr>
                </tbody>
            </table>
        </td>
    </tr>
    <% } %>

    <tr id="Row<%=row++%2%>"><td width="50%" align="right">&nbsp;</td><td width="50%">&nbsp;</td></tr>

    <%/* close CA form */%>
    </form>

    <% if (editca && !isexternal && hasEditRights) { %>
    <tr id="Row<%=row++%2%>" class="section">
        <td width="49%" valign="top" align="right"><strong><%= ejbcawebbean.getText("EXPORTCA_HEADER") %></strong></td><td width="50%">&nbsp;</td>
    </tr>
    <tr id="Row<%=row++%2%>">
        <td width="49%" valign="top" align="right">&nbsp;</td>
        <td width="51%" valign="top">
            <% if (cabean.isCaExportable(cainfo)) { %>
            <%= ejbcawebbean.getText("EXPORTCA_AUTHCODE") %><br/>
            <form name="exportca" action="<%= globalconfiguration.getCaPath() + "/exportca" %>" method="post">
                <input type="hidden" name="<csrf:tokenname/>" value="<csrf:tokenvalue/>"/>
		        <input type="hidden" name='<%= org.ejbca.ui.web.admin.cainterface.CAExportServlet.HIDDEN_CANAME %>' value='<c:out value="<%= cainfo.getName() %>"/>'/>
                <input type="password" autocomplete="off" name="<%= org.ejbca.ui.web.admin.cainterface.CAExportServlet.TEXTFIELD_EXPORTCA_PASSWORD %>"  value="" />
                <input type="submit" name="<%= BUTTON_EXPORTCA %>"  value="<%= ejbcawebbean.getText("EXPORTCA")+"..." %>" />
	        </form>
            <% } else { %>
                <%= ejbcawebbean.getText("EXPORTCA_NA") %><br/>
            <% } %>
        </td>
    </tr>
    <tr id="Row<%=row++%2%>"><td width="50%" align="right">&nbsp;</td><td width="50%">&nbsp;</td></tr>
	<% } %>

    <% } 
    // end "IF CVC AVAILABLE", search for "IF CVC AVAILABLE" to find the beginning { in the beginning of this file 
    %>

  </table>

<%/* Ensure that the right buttons are marked as disabled after they are drawn. */%>
<script>isExternalGeneric();</script>

