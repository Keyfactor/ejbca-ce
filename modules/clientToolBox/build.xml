<?xml version="1.0" encoding="UTF-8"?>
<project name="clientToolBox" default="build">
    <description>
		A stand alone CLI toolbox for interacting with EJBCA
    </description>

	<dirname property="this.dir" file="${ant.file.clientToolBox}"/>
	<import file="${this.dir}/../build.xml"/>
	
	<property name="build.dir" location="${this.dir}/build"/>
	<property name="src.dir" location="${this.dir}/src"/>

	<path id="clientToolBox.lib.classpath">
        <fileset dir="${ejbca.home}/lib">
            <include name="log4j.jar"/>
            <include name="bcprov-*.jar"/>
            <include name="commons-lang-2.4.jar"/>
            <include name="bcmail-*.jar"/>
            <include name="cert-cvc.jar"/>
            <include name="ldap.jar"/>
            <include name="commons-collections-3.2.jar"/>
            <include name="commons-configuration-1.5.jar"/>
            <include name="commons-logging.jar"/>
        </fileset>
		<path refid="lib.jpa.classpath"/>
	</path>

	<path id="clientToolBox.endorsed.classpath">
		<path refid="lib.jaxws-client.classpath"/>
	</path>

    <target name="build" description="Build this module" depends="compile">
    	<pathconvert property="clientToolBox.dependencies" pathsep=" ">
    	    <path>
	        	<fileset dir="${mod.clientToolBox.dist}" includes="lib/*.jar"/>
    	    </path>
    		<map from="${mod.clientToolBox.dist}/" to=""/>
    	</pathconvert>
        <jar jarfile="${mod.clientToolBox.lib}">
    		<manifest >
    			<attribute name="Class-path" value="${clientToolBox.dependencies} ./ properties/" />
    			<attribute name="Main-Class" value="org.ejbca.ui.cli.ClientToolBox"/>
    		</manifest>
            <fileset dir="${build.dir}"/>
            <fileset dir="${ejbca.home}/src">
                <include name="intresources/**"/>
            </fileset>
            <fileset dir="${ejbca.home}/src/java">
                <include name="dncomponents.properties"/>
                <include name="profilemappings.properties"/>
            </fileset>  
        </jar>
    </target>

    <target name="clean" description="Clean up this module">
		<delete dir="${build.dir}" />
		<delete dir="${mod.clientToolBox.dist}" />
    </target>
	
    <target name="compile" depends="setup">
    	<mkdir dir="${build.dir}" />
        <javac destdir="${build.dir}" debug="on" encoding="iso8859-1" target="${java.target.version}">
            <classpath>
            	<path refid="lib.bouncycastle.classpath"/>
            	<path refid="clientToolBox.lib.classpath"/>
               	<path refid="clientToolBox.endorsed.classpath"/>
            </classpath>
        	<src path="${src.dir}"/>
            <src path="${ejbca.home}/src/java" />
            <src path="${mod.cmpProxy.path}/src" />
            <src path="${mod.ejbca-ws.path}/src" />
            <src path="${mod.ejbca-ws-cli.path}/src" />
            <src path="${mod.ejbca-ws-cli.path}/src-gen" />
            <src path="${mod.ejbca-entity.path}/src" />
            <src path="${mod.ocsp-war.path}/src" />
        	
            <include name="org/ejbca/ui/cli/ClientToolBox.java" />
            <include name="org/ejbca/core/protocol/ws/client/ejbcawsracli.java" />
            <include name="org/ejbca/core/protocol/ws/client/cvcwscli.java" />
            <include name="org/ejbca/core/protocol/ws/client/gen/*.java" />
            <include name="org/ejbca/util/provider/TrustManagerFactoryImpl.java" />
            <include name="org/ejbca/core/protocol/ocsp/OCSPUnidResponse.java" />
        </javac>
    </target>

    <target name="setup">
    	<mkdir dir="${mod.clientToolBox.dist}"/>
    	<!-- Copy all the files in the clientToolBox.lib.classpath to mod.clientToolBox.dist/lib -->
    	<pathconvert property="lib.clientToolBox.classpath.property" pathsep=" ">
    	    <path refid="clientToolBox.lib.classpath" />
    		<map from="${ejbca.home}/" to=""/>
    	</pathconvert>
    	<copy todir="${mod.clientToolBox.dist}/lib" flatten="true">
    		<fileset dir="${ejbca.home}" includes="${lib.clientToolBox.classpath.property}"/>
    	</copy>
    	<!-- Copy all the files in the clientToolBox.endorsed.classpath to mod.clientToolBox.dist/endorsed -->
    	<pathconvert property="endorsed.clientToolBox.classpath.property" pathsep=" ">
    	    <path refid="clientToolBox.endorsed.classpath" />
    		<map from="${ejbca.home}/" to=""/>
    	</pathconvert>
    	<copy todir="${mod.clientToolBox.dist}/endorsed" flatten="true">
    		<fileset dir="${ejbca.home}" includes="${endorsed.clientToolBox.classpath.property}"/>
    	</copy>
    	<!-- Copy scripts etc to mod.clientToolBox.dist -->
        <copy todir="${mod.clientToolBox.dist}">
            <fileset file="${mod.ejbca-ws-cli.path}/resources/ejbcawsracli.properties"/>
            <fileset dir="${this.dir}/resources">
            	<include name="ejbcaClientToolBox.bat"/>
            	<include name="ejbcaClientToolBox.sh"/>
            	<include name="README"/>
            	<include name="properties/**/*.*"/>
        	</fileset>
        </copy>
        <chmod file="${mod.clientToolBox.dist}/*.sh" perm="a+rx"/>
    </target>

</project>
