<project name="jboss" basedir="." default="deploy">
	
	<property name="jboss.deploy.dir" location="${jboss.home}/server/default/deploy"/>
	<property name="jboss.server.home.dir" location="${jboss.deploy.dir}/.."/>
	<property name="keystore.file" value="conf/keystore/keystore.jks"/>
	<property name="keystore.password" value="${server.password}"/>

	<target name="j2ee:check">
		<available file="p12/tomcat.jks" property="keystore.file.present"/>
		<fail message="Missing JKS keystore file in '${basedir}/p12/tomcat.jsk'" unless="keystore.file.present"/>
		
		<property name="keystore.password" value="${server.password}"/>
		<fail message="Missing JKS keystore password 'keystore.password'" unless="server.password"/>
	</target>
	
	<target name="j2ee:configure" depends="j2ee:check" description="Configure the J2EE server with appropriate settings">
        <echo message="Using JBoss deploy directory ${jboss.deploy.dir}"/>

		<!-- copy the keystore file to the server -->
		<copy file="p12/tomcat.jks" tofile="${jboss.server.home.dir}/${keystore.file}"/>
		
        <!-- detect jboss web version -->
        <available file="${jboss.deploy.dir}/jbossweb-tomcat41.sar" type="dir" property="jboss.web" value="tomcat41"/>
        <available file="${jboss.deploy.dir}/jbossweb-tomcat50.sar" type="dir" property="jboss.web" value="tomcat50"/>
        <fail message="Could not detect JBoss Servlet container version" unless="jboss.web"/>
		
		<!-- configure the tomcat bundle -->
		<property name="tomcat.dir" location="${jboss.deploy.dir}/jbossweb-${jboss.web}.sar"/>
        <copy todir="${tomcat.dir}" overwrite="true">
			<fileset dir="src/appserver/jboss/${jboss.web}"/>
			<filterchain>
			<tokenfilter>
		    	<replacestring from="@keystore.file@" to="${keystore.file}"/>
		    	<replacestring from="@keystore.password@" to="${keystore.password}"/>
			</tokenfilter>
			</filterchain>
        </copy>
        
        <!-- configure the jetty bundle -->	
	</target>
	
	<target name="j2ee:deploy" description="Deploy the application" depends="j2ee:configure">
        <copy todir="${jboss.deploy.dir}" overwrite="true">
            <fileset dir="src/appserver/jboss" includes="ejbca-ds.xml"/>
            <filterchain>
                <expandproperties/>
            </filterchain>
        </copy>
    	<copy todir="${jboss.deploy.dir}">
    		<fileset dir="${dist.dir}" includes="*.ear"/>
    	</copy>
	</target>
	
	<target name="j2ee:assert-run" description="Check that the server is running">
        <echo message="Checking that the J2EE server is up and running..."/>
        <waitfor maxwait="2" maxwaitunit="second" timeoutproperty="j2ee.notrunning">
            <http url="http://localhost:8080/web-console/"/>
        </waitfor>
        <fail message="Please start J2EE server before running this script" if="j2ee.notrunning"/>	
	</target>
	
	<target name="j2ee:run" description="Start the J2EE server">
    	<j2ee-server classname="org.jboss.Main" classpath="${jboss.home}/bin/run.jar">
            <args>
                <jvmarg value="-Djboss.home=${jboss.home}"/>
            </args>
    	</j2ee-server>
    <!--
            jboss.home.dir
            jboss.home.url			${jboss.home.dir}
            jboss.server.name		default
            jboss.server.base.dir	${jboss.home.dir}/server	
            jboss.server.home.dir	${jboss.base.dir}/${jboss.server.name}
            jboss.server.temp.dir	${jboss.server.home.dir}/tmp
            jboss.server.data.dir	${jboss.server.home.dir}/data
            jboss.server.base.url	${jboss.home.url}/server
            jboss.server.home.url	${jboss.base.url}/${jboss.server.name}
            jboss.server.config.url ${jboss.server.home.url}/conf
            jboss.server.lib.url	${jboss.server.home.url}/lib
        -->		
	</target>
	
	<target name="j2ee:debug" description="Start the J2EE server in debug mode">
    	<property name="j2ee.debug.transport" value="dt_socket"/>
    	<property name="j2ee.debug.address" value="5005"/>
    	<property name="j2ee.debug.jvm.opts" value="-Xdebug -Xnoagent -Xrunjdwp:transport=${j2ee.debug.transport},address=${j2ee.debug.address},server=y,suspend=y"/>
		<echo message="Connect your debugger using transport '${j2ee.debug.transport}' and address '${j2ee.debug.address}'"/>
		<antcall target="j2ee:run"/>
	</target>
	
    <macrodef name="j2ee-server">
		<attribute name="classname"/>
		<attribute name="classpath"/>
        <element name="args" optional="yes"/>
        <sequential>
        <property name="j2ee.debug.jvm.opts" value=""/>
		<available file="${java.home}/../lib/tools.jar" property="jdk.present"/>
		<fail message="Missing tools.jar in ${java.home}/lib. Please use a java JDK" unless="jdk.present"/>
		<java classname="@{classname}" fork="true">
	    	<classpath path="@{classpath}:${java.home}/../lib/tools.jar"/>
	    	<jvmarg line="${j2ee.debug.jvm.opts}"/>
	    	<args/>
		</java>
        </sequential>
    </macrodef>
</project>

